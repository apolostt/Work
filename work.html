
<!DOCTYPE html>
<html lang="cs" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DZ Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #eef2f7;
            --text-primary: #1a202c;
            --text-secondary: #5a677d;
            --border-color: #dbe1e8;
            --accent-primary: #3498db;
            --accent-primary-hover: #2980b9;
            --accent-danger: #e74c3c;
            --accent-danger-hover: #c0392b;
            --accent-success: #2ecc71;
            --accent-success-hover: #27ae60;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: 'Inter', sans-serif;
        }

        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #252d3b;
            --text-primary: #edf2f7;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --accent-primary: #4299e1;
            --accent-primary-hover: #63b3ed;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #app-nav {
            width: 260px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        #app-main {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .nav-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 30px; }
        .nav-links a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-links a.active { background-color: var(--accent-primary); color: white; }
        .nav-links a:not(.active):hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .nav-links a svg { margin-right: 12px; }
        .nav-footer { margin-top: auto; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 1rem;
        }
        input:focus, select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }
        .form-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        .form-field { flex: 1; min-width: 150px; }

        .page { display: none; }
        .page.active { display: block; }
        .page-header { font-size: 2rem; font-weight: 700; margin-bottom: 25px; }

        .card {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 25px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .card-title { font-size: 1.25rem; font-weight: 600; }

        .btn {
            padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
            font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:hover { background-color: var(--accent-primary-hover); }
        .btn-success { background-color: var(--accent-success); color: white; }
        .btn-success:hover { background-color: var(--accent-success-hover); }
        .btn-danger { background-color: var(--accent-danger); color: white; }
        .btn-danger:hover { background-color: var(--accent-danger-hover); }
        .btn-icon { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background-color: var(--bg-tertiary); }
        .btn-icon svg { width: 20px; height: 20px; stroke: var(--text-secondary); }
        .btn-icon.danger:hover svg { stroke: var(--accent-danger); }

        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th, .data-table td { padding: 8px 6px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table .actions { text-align: right; }
        .shortage { color: var(--accent-danger); font-weight: 600; }
        .surplus { color: var(--accent-success); font-weight: 600; }

        .accordion details { margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; }
        .accordion summary {
            padding: 15px; font-weight: 600; cursor: pointer; list-style: none;
            display: flex; justify-content: space-between; align-items: center;
        }
        .accordion summary::-webkit-details-marker { display: none; }
        .accordion summary::after { content: '+'; font-size: 1.5rem; }
        .accordion details[open] summary { border-bottom: 1px solid var(--border-color); }
        .accordion details[open] summary::after { content: '−'; }
        .accordion .details-content { padding: 15px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 700px; }
        .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: var(--shadow); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 2.5s forwards; }
        .toast.success { background-color: var(--accent-success); }
        .toast.error { background-color: var(--accent-danger); }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; } }

        /* Calendar Styles */
        .calendar-toolbar { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        #current-month-display { font-size: 1.5rem; font-weight: 600; text-align: center; flex-grow: 1; }
        .calendar-grid { display: grid; grid-template-columns: 50px repeat(7, 1fr); gap: 5px; }
        .calendar-header { text-align: center; font-weight: 600; color: var(--text-secondary); padding-bottom: 10px; }
        .week-number { font-weight: bold; color: var(--accent-primary); display: flex; align-items: center; justify-content: center; }
        .calendar-day { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; min-height: 100px; padding: 8px; position: relative; cursor: pointer; transition: box-shadow 0.2s; }
        .calendar-day:hover { box-shadow: var(--shadow); }
        .day-number { font-weight: 600; margin-bottom: 5px; }
        .day-items { display: flex; flex-direction: column; gap: 4px; font-size: 0.75rem; }
        .day-pill { background-color: var(--accent-primary); color: white; padding: 2px 5px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .day-pill.is-order { background-color: var(--accent-success); }
        
        /* People Calendar Specific Styles */
        #people-calendar-container {
            --primary:#0d6efd;
            --radius:8px;
        }
        #people-calendar-container .stats{display:flex;gap:14px;justify-content:center;margin-bottom:20px}
        #people-calendar-container .stat{flex:1 1 120px;background:var(--bg-secondary);padding:10px;border-radius:var(--radius);text-align:center;box-shadow:var(--shadow)}
        #people-calendar-container .stat h3{margin-bottom:4px;font-size:14px}
        #people-calendar-container .month-bar{display:flex;justify-content:center;align-items:center;gap:10px;margin-bottom:14px}
        #people-calendar-container .month-bar button{background:var(--accent-primary);color:#fff;border:0;border-radius:var(--radius);padding:6px 10px;font-weight:600;cursor:pointer}
        #people-calendar-container .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
        #people-calendar-container .dow, #people-calendar-container .day{border:1px solid var(--border-color);background:var(--bg-secondary);min-height:80px;display:flex;flex-direction:column}
        #people-calendar-container .dow{background:var(--bg-tertiary);align-items:center;justify-content:center;font-weight:700;min-height:30px}
        #people-calendar-container .day.disabled{background:var(--bg-tertiary)}
        #people-calendar-container .day span.date{font-size:12px;font-weight:600;padding:4px}
        #people-calendar-container .day .tags{font-size:12px;line-height:1.2;padding:2px 4px}
        #people-calendar-container .weekend{background:var(--bg-tertiary)}
        #people-calendar-container .buttons {display: flex; justify-content: space-between; margin-bottom: 10px;}
        #people-calendar-container .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:1001}
        #people-calendar-container .modal{background:var(--bg-secondary);padding:20px;border-radius:var(--radius);width:90%;max-width:800px}
        #people-calendar-container .modal label{display:block;margin:8px 0 2px;font-size:14px;font-weight:600}
        #people-calendar-container .modal input,#people-calendar-container .modal select{width:100%;padding:6px;border:1px solid var(--border-color);border-radius:6px;font-size:14px; background: var(--bg-secondary); color: var(--text-primary)}
        #people-calendar-container .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:14px}
        #people-calendar-container .actions button{border:0;border-radius:var(--radius);padding:6px 12px;font-weight:600;cursor:pointer}
        #people-calendar-container .cancel{background:#6c757d;color:#fff}
        #people-calendar-container .save{background:var(--accent-primary);color:#fff}
        #people-calendar-container .summary{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:16px}
        #people-calendar-container .post{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:var(--radius);padding:6px 10px;font-size:13px}
        #people-calendar-container .event-item {display: flex; justify-content: space-between; align-items: center; margin: 8px 0; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px;}
        #people-calendar-container .event-item button {padding: 4px 8px; font-size: 12px; border: 0; border-radius: 4px; cursor: pointer; background: var(--accent-primary); color: #fff;}
        #people-calendar-container .people-modal .shifts{display:flex;gap:20px}
        #people-calendar-container .people-modal .shift{flex:1}
        #people-calendar-container .people-modal .person-item{display:flex;justify-content:space-between;align-items:center;margin:8px 0;padding:8px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px}
        #people-calendar-container .people-modal .person-item button{padding:4px 8px;font-size:12px;border:0;border-radius:4px;cursor:pointer}
        #people-calendar-container .people-modal .person-item button.edit{background:var(--accent-primary);color:#fff;margin-right:4px}
        #people-calendar-container .people-modal .person-item button.delete{background:var(--accent-danger);color:#fff}
    </style>
</head>
<body>

    <nav id="app-nav">
        <div>
            <div class="nav-header">DZ Control</div>
            <div class="nav-links">
                <a href="#" class="nav-link active" data-view="daily-plan"><span>Denní Plán</span></a>
                <a href="#" class="nav-link" data-view="orders"><span>Objednávky</span></a>
                <a href="#" class="nav-link" data-view="calendar"><span>Kalendář akcí</span></a>
                <a href="#" class="nav-link" data-view="people-calendar"><span>Kalendář lidí</span></a>
                <a href="#" class="nav-link" data-view="box-weights"><span>Váhy beden</span></a>
                <a href="#" class="nav-link" data-view="create-mix"><span>Vytvořit mix</span></a>
                <a href="#" class="nav-link" data-view="palette-weights"><span>Váhy palet</span></a>
            </div>
        </div>
        <div class="nav-footer">
            <div class="form-group">
                <label for="selectedDate">Datum plánu</label>
                <input type="date" id="selectedDate">
            </div>
        </div>
    </nav>

    <main id="app-main">
        <!-- 1. Denní Plán View -->
        <div id="view-daily-plan" class="page active">
            <h1 class="page-header">Denní Plán</h1>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Přehled Surovin na Den</h2></div>
                <div class="card-content">
                    <table class="data-table" id="suroviny-overview-table">
                        <thead><tr><th>Surovina</th><th>Skladem (palet)</th><th>Potřeba (kg)</th><th>Chybí / Přebývá (palet)</th><th>Následující den (kg)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 2. Objednávky View -->
        <div id="view-orders" class="page">
            <h1 class="page-header">Objednávky</h1>
            <div class="accordion" id="orders-accordion"></div>
        </div>
        
        <!-- 3. Kalendář akcí View -->
        <div id="view-calendar" class="page">
            <h1 class="page-header">Kalendář akcí</h1>
            <div class="card">
                 <div class="calendar-toolbar">
                     <button id="prev-month-btn" class="btn btn-primary">Předchozí</button>
                     <div id="current-month-display"></div>
                     <button id="next-month-btn" class="btn btn-primary">Další</button>
                     <button id="plan-action-btn" class="btn btn-success">+ Přidat akci</button>
                 </div>
                 <div class="calendar-grid" id="calendar-grid">
                    <!-- JS generated content -->
                 </div>
            </div>
        </div>
        
        <!-- 4. Kalendář lidí View -->
        <div id="view-people-calendar" class="page">
             <div id="people-calendar-container">
                <!-- Injected HTML from user file -->
             </div>
        </div>

        <!-- 5. Váhy Beden View -->
        <div id="view-box-weights" class="page">
            <h1 class="page-header">Váhy beden dle zákazníka</h1>
            <div class="card">
                <div class="accordion" id="box-weights-accordion"></div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" id="save-all-box-weights-btn">Uložit všechny změny</button>
                </div>
            </div>
        </div>

        <!-- 6. Vytvořit Mix View -->
        <div id="view-create-mix" class="page">
            <h1 class="page-header" id="create-mix-header">Vytvořit nový mix</h1>
            <div class="card">
                <div class="form-row">
                    <div class="form-field"><label for="new-product-name">Název mixu</label><input type="text" id="new-product-name"></div>
                </div>
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <h3>Složení mixu</h3>
                <div id="new-product-components"></div>
                <button class="btn btn-success" id="add-new-product-component-btn" style="margin-top: 10px;">+ Přidat surovinu</button>
                <div style="font-weight: bold; margin-top: 15px;">Celkem: <span id="new-product-total-percentage">0</span>%</div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" id="save-new-product-btn">Uložit mix</button>
                    <button class="btn" id="cancel-edit-mix-btn" style="display: none;">Zrušit úpravu</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2 class="card-title">Existující mixy</h2></div>
                <div class="card-content">
                    <table class="data-table" id="existing-mixes-table">
                        <thead><tr><th>Název mixu</th><th>Složení</th><th class="actions">Akce</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 7. Váhy Palet View -->
        <div id="view-palette-weights" class="page">
            <h1 class="page-header">Váhy palet</h1>
            <div class="card">
                <table class="data-table" id="palette-weights-table">
                    <thead><tr><th>Surovina</th><th>Váha palety (kg)</th></tr></thead>
                    <tbody></tbody>
                </table>
                 <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" id="save-all-palette-weights-btn">Uložit všechny změny</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="mix-ratio-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="mix-ratio-modal-title">Upravit poměr surovin</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="mix-ratio-modal-body"></div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zrušit</button>
                <button class="btn btn-primary" id="save-mix-ratio-btn">Uložit poměr</button>
            </div>
        </div>
    </div>

    <div id="add-order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="add-order-modal-title">Přidat položky do objednávky</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="add-order-modal-body"></div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zrušit</button>
                <button class="btn btn-primary" id="save-added-items-btn">Přidat do objednávky</button>
            </div>
        </div>
    </div>

    <div id="plan-action-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="plan-action-modal-title">Naplánovat akci</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-field"><label>Zákazník</label><select id="plan-action-customer"></select></div>
                    <div class="form-field"><label>Produkt</label><select id="plan-action-product"></select></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label>Od</label><input type="date" id="plan-action-from"></div>
                    <div class="form-field"><label>Do</label><input type="date" id="plan-action-to"></div>
                </div>
                <div id="plan-action-daily-counts"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zrušit</button>
                <button class="btn btn-primary" id="save-planned-action-btn">Uložit akci</button>
            </div>
        </div>
    </div>
    
    <div id="day-details-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="day-details-title">Detail dne</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="day-details-body"></div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
    // --- MAIN APP SCRIPT ---
    document.addEventListener('DOMContentLoaded', () => {
        const ICONS = {
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>`,
        };

        let appState = {};
        let peopleCalendarInitialized = false;

        const DOMElements = {
            navLinks: document.querySelectorAll('.nav-link'),
            views: document.querySelectorAll('.page'),
            selectedDateInput: document.getElementById('selectedDate'),
            surovinyOverviewTableBody: document.querySelector('#suroviny-overview-table tbody'),
            ordersAccordion: document.getElementById('orders-accordion'),
            calendarGrid: document.getElementById('calendar-grid'),
            currentMonthDisplay: document.getElementById('current-month-display'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            planActionBtn: document.getElementById('plan-action-btn'),
            boxWeightsAccordion: document.getElementById('box-weights-accordion'),
            saveAllBoxWeightsBtn: document.getElementById('save-all-box-weights-btn'),
            createMixHeader: document.getElementById('create-mix-header'),
            newProductName: document.getElementById('new-product-name'),
            newProductComponents: document.getElementById('new-product-components'),
            addNewProductComponentBtn: document.getElementById('add-new-product-component-btn'),
            newProductTotalPercentage: document.getElementById('new-product-total-percentage'),
            saveNewProductBtn: document.getElementById('save-new-product-btn'),
            cancelEditMixBtn: document.getElementById('cancel-edit-mix-btn'),
            existingMixesTableBody: document.querySelector('#existing-mixes-table tbody'),
            paletteWeightsTableBody: document.querySelector('#palette-weights-table tbody'),
            saveAllPaletteWeightsBtn: document.getElementById('save-all-palette-weights-btn'),
            // Modals
            mixRatioModal: document.getElementById('mix-ratio-modal'),
            mixRatioModalTitle: document.getElementById('mix-ratio-modal-title'),
            mixRatioModalBody: document.getElementById('mix-ratio-modal-body'),
            saveMixRatioBtn: document.getElementById('save-mix-ratio-btn'),
            addOrderModal: document.getElementById('add-order-modal'),
            addOrderModalTitle: document.getElementById('add-order-modal-title'),
            addOrderModalBody: document.getElementById('add-order-modal-body'),
            saveAddedItemsBtn: document.getElementById('save-added-items-btn'),
            planActionModal: document.getElementById('plan-action-modal'),
            planActionModalTitle: document.getElementById('plan-action-modal-title'),
            planActionCustomer: document.getElementById('plan-action-customer'),
            planActionProduct: document.getElementById('plan-action-product'),
            planActionFrom: document.getElementById('plan-action-from'),
            planActionTo: document.getElementById('plan-action-to'),
            planActionDailyCounts: document.getElementById('plan-action-daily-counts'),
            savePlannedActionBtn: document.getElementById('save-planned-action-btn'),
            dayDetailsModal: document.getElementById('day-details-modal'),
            dayDetailsTitle: document.getElementById('day-details-title'),
            dayDetailsBody: document.getElementById('day-details-body'),
            toastContainer: document.getElementById('toast-container'),
        };

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

        function loadState() {
            const savedState = localStorage.getItem('surovinyAppData_v7');
            if (savedState) {
                appState = JSON.parse(savedState);
            } else {
                setupDefaultData();
            }
            const today = new Date();
            appState.ui = {
                selectedDate: today.toISOString().split('T')[0],
                activeView: 'daily-plan',
                editingOrderItemId: null,
                addingToCustomerId: null,
                editingMixId: null,
                editingActionId: null,
                calendar: {
                    year: today.getFullYear(),
                    month: today.getMonth(), // 0-indexed
                }
            };
        }

        function saveState() {
            const stateToSave = { ...appState };
            delete stateToSave.ui; 
            localStorage.setItem('surovinyAppData_v7', JSON.stringify(stateToSave));
        }

        function setupDefaultData() {
            appState.suroviny = [
                {id: 's01', name: 'ŘÍZKY'}, {id: 's02', name: 'STRIPS'}, {id: 's03', name: 'PRSA'},
                {id: 's04', name: 'HRBETY'}, {id: 's05', name: 'PRDELE'}, {id: 's06', name: 'HORNÍ STEHNA'},
                {id: 's07', name: 'SPODNÍ STEHNA'}, {id: 's08', name: 'ČTVRTKY'}, {id: 's09', name: 'KŘÍDLA'},
                {id: 's10', name: 'PLACKY'}, {id: 's11', name: 'BANDURY'}, {id: 's12', name: 'STEAK'},
                {id: 's13', name: 'JÁTRA'}, {id: 's14', name: 'SRDCE'}, {id: 's15', name: 'ŽALUDKY'}, {id: 's16', name: 'KRKY'}
            ].map(s => ({ ...s, paletteWeight: 500, stock: 0, isMix: false }));

            appState.zakaznici = [
                {id: 'c1', name: 'Ahold'}, {id: 'c2', name: 'Billa'}, {id: 'c3', name: 'Tesco'},
                {id: 'c4', name: 'Kaufland'}, {id: 'c5', name: 'Lidl'}, {id: 'c6', name: 'Rohlik'}
            ];

            appState.boxWeights = {}; // { customerId: { surovinaId: weightInGrams } }
            appState.zakaznici.forEach(c => {
                appState.boxWeights[c.id] = {};
                appState.suroviny.forEach(s => {
                    appState.boxWeights[c.id][s.id] = 10000; // default 10000g (10kg)
                });
            });

            appState.orders = []; // { id, date, customerId, items: [{id, surovinaId, boxCount, ratioOverride}] }
            appState.mixDefinitions = {}; // { mixId: { components: [{surovinaId, percentage, loss}] } }
            appState.plannedActions = []; // {id, customerId, surovinaId, startDate, endDate, dailyCounts: {'YYYY-MM-DD': count}}
        }

        function bindEvents() {
            DOMElements.navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    appState.ui.activeView = e.currentTarget.dataset.view;
                    render();
                });
            });
            DOMElements.selectedDateInput.addEventListener('change', () => {
                appState.ui.selectedDate = DOMElements.selectedDateInput.value;
                render();
            });
            DOMElements.saveAllBoxWeightsBtn.addEventListener('click', saveAllBoxWeights);
            DOMElements.addNewProductComponentBtn.addEventListener('click', () => renderNewProductComponents(true));
            DOMElements.saveNewProductBtn.addEventListener('click', saveNewProduct);
            DOMElements.cancelEditMixBtn.addEventListener('click', cancelEditMix);
            DOMElements.saveAllPaletteWeightsBtn.addEventListener('click', saveAllPaletteWeights);
            DOMElements.saveMixRatioBtn.addEventListener('click', saveMixRatio);
            DOMElements.saveAddedItemsBtn.addEventListener('click', saveAddedItems);
            // Calendar
            DOMElements.prevMonthBtn.addEventListener('click', () => changeMonth(-1));
            DOMElements.nextMonthBtn.addEventListener('click', () => changeMonth(1));
            DOMElements.planActionBtn.addEventListener('click', () => openPlanActionModal());
            DOMElements.savePlannedActionBtn.addEventListener('click', savePlannedAction);
            DOMElements.planActionFrom.addEventListener('change', renderDailyCountsForPlanning);
            DOMElements.planActionTo.addEventListener('change', renderDailyCountsForPlanning);

            document.body.addEventListener('click', handleGlobalClick);
        }

        function handleGlobalClick(e) {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const { action, customerId, orderId, itemId, mixId, date, actionId } = actionTarget.dataset;

            switch (action) {
                case 'add-order-items': openAddOrderModal(customerId); break;
                case 'delete-order-item': deleteOrderItem(orderId, itemId); break;
                case 'edit-mix-ratio': openMixRatioModal(orderId, itemId); break;
                case 'delete-new-product-component': actionTarget.closest('.form-row').remove(); updateNewProductTotalPercentage(); break;
                case 'edit-mix': openMixEditor(mixId); break;
                case 'delete-mix': deleteMix(mixId); break;
                case 'open-day-details': openDayDetailsModal(date); break;
                case 'edit-action': openPlanActionModal(actionId); break;
                case 'delete-action': deletePlannedAction(actionId); break;
                case 'close-modal': actionTarget.closest('.modal').classList.remove('active'); break;
            }
        }

        function getDailyNeeds(date) {
            const needs = {};
            appState.suroviny.filter(s => !s.isMix).forEach(s => { needs[s.id] = 0; });
            
            // Standard orders for the day
            const dailyOrders = appState.orders.filter(o => o.date === date);
            // Planned actions that are active on this day
            const activeActions = appState.plannedActions.filter(a => date >= a.startDate && date <= a.endDate);

            const allItemsForDay = [];
            dailyOrders.forEach(order => {
                order.items.forEach(item => allItemsForDay.push({ ...item, customerId: order.customerId }));
            });
            activeActions.forEach(action => {
                const boxCount = action.dailyCounts[date];
                if(boxCount > 0) {
                    allItemsForDay.push({ surovinaId: action.surovinaId, boxCount, customerId: action.customerId });
                }
            });

            allItemsForDay.forEach(item => {
                const surovina = appState.suroviny.find(s => s.id === item.surovinaId);
                if (!surovina) return;
                
                const boxWeightInGrams = appState.boxWeights[item.customerId]?.[surovina.id] || 0;
                const totalWeightInKg = item.boxCount * (boxWeightInGrams / 1000);

                if (surovina.isMix) {
                    const components = item.ratioOverride || appState.mixDefinitions[surovina.id]?.components;
                    if (components) {
                        components.forEach(comp => {
                            const grossWeight = totalWeightInKg * (comp.percentage / 100);
                            const netWeight = grossWeight * (1 - ((comp.loss || 0) / 100));
                            needs[comp.surovinaId] = (needs[comp.surovinaId] || 0) + netWeight;
                        });
                    }
                } else {
                    needs[surovina.id] = (needs[surovina.id] || 0) + totalWeightInKg;
                }
            });
            return needs;
        }

        // --- RENDER FUNCTIONS ---
        function render() {
            DOMElements.selectedDateInput.value = appState.ui.selectedDate;
            DOMElements.views.forEach(v => v.classList.remove('active'));
            DOMElements.navLinks.forEach(l => l.classList.remove('active'));
            
            const activeView = document.getElementById(`view-${appState.ui.activeView}`);
            const activeLink = document.querySelector(`.nav-link[data-view="${appState.ui.activeView}"]`);
            if (activeView) activeView.classList.add('active');
            if (activeLink) activeLink.classList.add('active');

            switch (appState.ui.activeView) {
                case 'daily-plan': renderDailyPlan(); break;
                case 'orders': renderOrders(); break;
                case 'calendar': renderCalendar(); break;
                case 'people-calendar': initPeopleCalendar(); break;
                case 'box-weights': renderBoxWeights(); break;
                case 'create-mix': renderCreateMix(); break;
                case 'palette-weights': renderPaletteWeights(); break;
            }
        }

        function renderDailyPlan() {
            const todayNeeds = getDailyNeeds(appState.ui.selectedDate);
            const nextDay = new Date(appState.ui.selectedDate);
            nextDay.setDate(nextDay.getDate() + 1);
            const tomorrowNeeds = getDailyNeeds(nextDay.toISOString().split('T')[0]);

            const tbody = DOMElements.surovinyOverviewTableBody;
            tbody.innerHTML = '';
            appState.suroviny.filter(s => !s.isMix).forEach(s => {
                const neededKg = todayNeeds[s.id] || 0;
                const neededPalettes = s.paletteWeight > 0 ? (neededKg / s.paletteWeight) : 0;
                const balancePalettes = (s.stock || 0) - neededPalettes;
                
                let balanceHtml = '';
                if (balancePalettes < -0.01) {
                    balanceHtml = `<span class="shortage">- ${Math.ceil(Math.abs(balancePalettes))}</span>`;
                } else {
                    balanceHtml = `<span class="surplus">+ ${Math.floor(balancePalettes)}</span>`;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.name}</td>
                    <td><input type="number" value="${s.stock || 0}" data-surovina-id="${s.id}" class="stock-input" style="width: 80px;"></td>
                    <td>${neededKg.toFixed(2)} kg</td>
                    <td>${balanceHtml}</td>
                    <td>${(tomorrowNeeds[s.id] || 0).toFixed(2)} kg</td>
                `;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.stock-input').forEach(input => {
                input.addEventListener('change', e => {
                    const surovina = appState.suroviny.find(s => s.id === e.target.dataset.surovinaId);
                    if (surovina) surovina.stock = parseFloat(e.target.value) || 0;
                    saveState();
                    renderDailyPlan();
                });
            });
        }

        function renderOrders() {
            const accordion = DOMElements.ordersAccordion;
            accordion.innerHTML = '';
            appState.zakaznici.forEach(customer => {
                const details = document.createElement('details');
                details.innerHTML = `<summary>${customer.name}</summary><div class="details-content"></div>`;
                const content = details.querySelector('.details-content');
                
                const customerOrders = appState.orders.filter(o => o.customerId === customer.id && o.date === appState.ui.selectedDate);
                const table = document.createElement('table');
                table.className = 'data-table';
                table.innerHTML = `<thead><tr><th>Produkt</th><th>Počet beden</th><th>Akce</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');

                customerOrders.forEach(order => {
                    order.items.forEach(item => {
                        const surovina = appState.suroviny.find(s => s.id === item.surovinaId);
                        if (!surovina) return;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${surovina.name}</td>
                            <td><input type="number" value="${item.boxCount}" data-order-id="${order.id}" data-item-id="${item.id}" class="order-box-count-input" style="width: 80px;"></td>
                            <td class="actions">
                                ${surovina.isMix ? `<button class="btn btn-primary" data-action="edit-mix-ratio" data-order-id="${order.id}" data-item-id="${item.id}">Poměr</button>` : ''}
                                <button class="btn-icon danger" data-action="delete-order-item" data-order-id="${order.id}" data-item-id="${item.id}">${ICONS.trash}</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
                
                content.appendChild(table);
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-success';
                addBtn.textContent = '+ Přidat položky';
                addBtn.dataset.action = 'add-order-items';
                addBtn.dataset.customerId = customer.id;
                content.appendChild(addBtn);
                accordion.appendChild(details);
            });
            
            accordion.querySelectorAll('.order-box-count-input').forEach(input => {
                input.addEventListener('change', e => {
                    const order = appState.orders.find(o => o.id === e.target.dataset.orderId);
                    const item = order?.items.find(i => i.id === e.target.dataset.itemId);
                    if (item) item.boxCount = parseInt(e.target.value) || 0;
                    saveState();
                });
            });
        }
        
        function renderBoxWeights() {
            const accordion = DOMElements.boxWeightsAccordion;
            accordion.innerHTML = '';
            appState.zakaznici.forEach(customer => {
                const details = document.createElement('details');
                details.innerHTML = `<summary>${customer.name}</summary><div class="details-content"></div>`;
                const content = details.querySelector('.details-content');
                const table = document.createElement('table');
                table.className = 'data-table';
                table.innerHTML = `<thead><tr><th>Produkt</th><th>Váha bedny (g)</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');

                appState.suroviny.forEach(surovina => {
                    const weight = appState.boxWeights[customer.id]?.[surovina.id] || 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${surovina.name}</td>
                        <td><input type="number" value="${weight}" data-customer-id="${customer.id}" data-surovina-id="${surovina.id}" class="box-weight-input" style="width: 100px;"></td>
                    `;
                    tbody.appendChild(tr);
                });
                content.appendChild(table);
                accordion.appendChild(details);
            });
        }

        function renderCreateMix() {
            cancelEditMix(); // Reset form
            renderExistingMixes();
        }

        function renderPaletteWeights() {
            const tbody = DOMElements.paletteWeightsTableBody;
            tbody.innerHTML = '';
            appState.suroviny.filter(s => !s.isMix).forEach(surovina => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${surovina.name}</td>
                    <td><input type="number" value="${surovina.paletteWeight || 500}" data-surovina-id="${surovina.id}" class="palette-weight-input" style="width: 120px;"></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderNewProductComponents(addComponent = false, components = []) {
            const container = DOMElements.newProductComponents;
            if (!addComponent) {
                container.innerHTML = '';
            }
            
            const renderRow = (component = {}) => {
                const row = document.createElement('div');
                row.className = 'form-row';
                const rawMaterials = appState.suroviny.filter(s => !s.isMix);
                row.innerHTML = `
                    <div class="form-field" style="flex: 2;">
                        <label>Surovina</label>
                        <select class="new-product-component-surovina">${rawMaterials.map(s => `<option value="${s.id}" ${component.surovinaId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}</select>
                    </div>
                    <div class="form-field">
                        <label>Podíl (%)</label>
                        <input type="number" class="new-product-component-percentage" value="${component.percentage || 0}" min="0" max="100" step="0.1">
                    </div>
                    <div class="form-field">
                        <label>Ztráta (%)</label>
                        <input type="number" class="new-product-component-loss" value="${component.loss || 0}" min="0" max="100" step="0.1">
                    </div>
                    <button class="btn-icon danger" data-action="delete-new-product-component">${ICONS.trash}</button>
                `;
                container.appendChild(row);
            };

            if (addComponent) {
                renderRow();
            } else {
                if (components.length > 0) {
                    components.forEach(renderRow);
                } else {
                    renderRow(); // Start with one empty row
                }
            }
            
            container.querySelectorAll('.new-product-component-percentage').forEach(input => {
                input.addEventListener('input', updateNewProductTotalPercentage);
            });
            updateNewProductTotalPercentage();
        }

        function updateNewProductTotalPercentage() {
            let total = 0;
            document.querySelectorAll('.new-product-component-percentage').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            const totalEl = DOMElements.newProductTotalPercentage;
            totalEl.textContent = total.toFixed(1);
            totalEl.style.color = Math.abs(total - 100) > 0.1 ? 'var(--accent-danger)' : 'var(--accent-success)';
        }

        function renderExistingMixes() {
            const tbody = DOMElements.existingMixesTableBody;
            if (!tbody) return; 
            tbody.innerHTML = '';
            const mixes = appState.suroviny.filter(s => s.isMix);
            mixes.forEach(mix => {
                const mixDef = appState.mixDefinitions[mix.id];
                const componentsString = mixDef.components.map(c => {
                    const surovina = appState.suroviny.find(s => s.id === c.surovinaId);
                    return `${surovina.name} (${c.percentage}%)`;
                }).join(', ');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${mix.name}</td>
                    <td>${componentsString}</td>
                    <td class="actions">
                        <button class="btn-icon" data-action="edit-mix" data-mix-id="${mix.id}">${ICONS.edit}</button>
                        <button class="btn-icon danger" data-action="delete-mix" data-mix-id="${mix.id}">${ICONS.trash}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // --- Calendar Functions ---
        function changeMonth(delta) {
            appState.ui.calendar.month += delta;
            if (appState.ui.calendar.month > 11) {
                appState.ui.calendar.month = 0;
                appState.ui.calendar.year++;
            } else if (appState.ui.calendar.month < 0) {
                appState.ui.calendar.month = 11;
                appState.ui.calendar.year--;
            }
            renderCalendar();
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        function renderCalendar() {
            const { year, month } = appState.ui.calendar;
            DOMElements.currentMonthDisplay.textContent = new Date(year, month).toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' });
            const grid = DOMElements.calendarGrid;
            grid.innerHTML = '';

            // Headers
            grid.innerHTML += `<div class="calendar-header"></div>`; // For week numbers
            ['Po', 'Út', 'St', 'Čt', 'Pá', 'So', 'Ne'].forEach(day => {
                grid.innerHTML += `<div class="calendar-header">${day}</div>`;
            });

            const firstDayOfMonth = new Date(year, month, 1);
            let dayOfWeek = firstDayOfMonth.getDay();
            if (dayOfWeek === 0) dayOfWeek = 7; // Sunday
            const offset = dayOfWeek - 1;

            let currentDate = new Date(firstDayOfMonth);
            currentDate.setDate(currentDate.getDate() - offset);

            for (let i = 0; i < 6; i++) { // 6 weeks to cover all possibilities
                const weekNum = getWeekNumber(currentDate);
                grid.innerHTML += `<div class="week-number">${weekNum}</div>`;
                for (let j = 0; j < 7; j++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day';
                    if (currentDate.getMonth() !== month) {
                        dayCell.style.opacity = '0.5';
                    }
                    const dateStr = currentDate.toISOString().split('T')[0];
                    dayCell.dataset.action = 'open-day-details';
                    dayCell.dataset.date = dateStr;

                    dayCell.innerHTML = `<div class="day-number">${currentDate.getDate()}</div><div class="day-items"></div>`;
                    
                    const itemsDiv = dayCell.querySelector('.day-items');
                    const dayActions = appState.plannedActions.filter(a => dateStr >= a.startDate && dateStr <= a.endDate);
                    const dayOrders = appState.orders.filter(o => o.date === dateStr);
                    
                    dayActions.forEach(action => {
                        const customer = appState.zakaznici.find(c => c.id === action.customerId);
                        itemsDiv.innerHTML += `<div class="day-pill">${customer.name} (Akce)</div>`;
                    });
                    if (dayOrders.length > 0) {
                         itemsDiv.innerHTML += `<div class="day-pill is-order">Objednávka</div>`;
                    }

                    grid.appendChild(dayCell);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
        }
        
        function openMixEditor(mixId) {
            const mix = appState.suroviny.find(s => s.id === mixId);
            const mixDef = appState.mixDefinitions[mixId];
            if (!mix || !mixDef) return;

            appState.ui.editingMixId = mixId;
            DOMElements.createMixHeader.textContent = `Upravit mix: ${mix.name}`;
            DOMElements.newProductName.value = mix.name;
            DOMElements.saveNewProductBtn.textContent = 'Uložit změny';
            DOMElements.cancelEditMixBtn.style.display = 'inline-block';
            
            renderNewProductComponents(false, mixDef.components);
            window.scrollTo(0, 0);
        }

        function cancelEditMix() {
            appState.ui.editingMixId = null;
            DOMElements.createMixHeader.textContent = 'Vytvořit nový mix';
            DOMElements.newProductName.value = '';
            DOMElements.saveNewProductBtn.textContent = 'Uložit mix';
            DOMElements.cancelEditMixBtn.style.display = 'none';
            renderNewProductComponents();
        }

        function deleteMix(mixId) {
            if (confirm('Opravdu chcete smazat tento mix? Bude odstraněn i ze všech objednávek.')) {
                appState.suroviny = appState.suroviny.filter(s => s.id !== mixId);
                delete appState.mixDefinitions[mixId];
                appState.orders.forEach(order => {
                    order.items = order.items.filter(item => item.surovinaId !== mixId);
                });
                saveState();
                renderCreateMix();
                showToast('Mix smazán', 'error');
            }
        }

        function openMixRatioModal(orderId, itemId) {
            appState.ui.editingOrderItemId = itemId;
            const order = appState.orders.find(o => o.id === orderId);
            const item = order?.items.find(i => i.id === itemId);
            const surovina = appState.suroviny.find(s => s.id === item.surovinaId);
            if (!item || !surovina || !surovina.isMix) return;

            DOMElements.mixRatioModalTitle.textContent = `Poměr pro: ${surovina.name}`;
            const body = DOMElements.mixRatioModalBody;
            body.innerHTML = '';
            
            const components = item.ratioOverride || appState.mixDefinitions[surovina.id].components;
            components.forEach(comp => {
                const compSurovina = appState.suroviny.find(s => s.id === comp.surovinaId);
                const row = document.createElement('div');
                row.className = 'form-row';
                row.innerHTML = `
                    <div class="form-field" style="flex: 3;"><label>${compSurovina.name}</label></div>
                    <div class="form-field"><input type="number" class="mix-ratio-percentage" value="${comp.percentage}" data-surovina-id="${comp.surovinaId}" min="0" max="100"></div>
                `;
                body.appendChild(row);
            });
            DOMElements.mixRatioModal.classList.add('active');
        }

        function openAddOrderModal(customerId) {
            appState.ui.addingToCustomerId = customerId;
            const customer = appState.zakaznici.find(c => c.id === customerId);
            DOMElements.addOrderModalTitle.textContent = `Přidat objednávku pro: ${customer.name}`;
            const body = DOMElements.addOrderModalBody;
            body.innerHTML = '';
            
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `<thead><tr><th>Produkt</th><th>Počet beden</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            
            appState.suroviny.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.name}</td>
                    <td><input type="number" min="0" class="add-order-box-count" data-surovina-id="${s.id}" style="width: 100px;"></td>
                `;
                tbody.appendChild(tr);
            });
            body.appendChild(table);
            DOMElements.addOrderModal.classList.add('active');
        }
        
        function openPlanActionModal(actionId = null) {
            appState.ui.editingActionId = actionId;
            const { planActionCustomer, planActionProduct, planActionFrom, planActionTo, planActionModalTitle } = DOMElements;
            
            planActionCustomer.innerHTML = appState.zakaznici.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            planActionProduct.innerHTML = appState.suroviny.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            if (actionId) {
                const action = appState.plannedActions.find(a => a.id === actionId);
                if (action) {
                    planActionModalTitle.textContent = 'Upravit akci';
                    planActionCustomer.value = action.customerId;
                    planActionProduct.value = action.surovinaId;
                    planActionFrom.value = action.startDate;
                    planActionTo.value = action.endDate;
                } else {
                    console.error(`Action with id ${actionId} not found.`);
                    appState.ui.editingActionId = null; // Reset
                    actionId = null; // Treat as new
                }
            } 
            
            if (!actionId) {
                planActionModalTitle.textContent = 'Naplánovat akci';
                planActionFrom.value = '';
                planActionTo.value = '';
            }

            renderDailyCountsForPlanning();
            DOMElements.planActionModal.classList.add('active');
        }

        function renderDailyCountsForPlanning() {
            const { planActionFrom, planActionTo, planActionDailyCounts } = DOMElements;
            const from = planActionFrom.value;
            const to = planActionTo.value;
            planActionDailyCounts.innerHTML = '';
            if (!from || !to || to < from) return;

            const action = appState.ui.editingActionId ? appState.plannedActions.find(a => a.id === appState.ui.editingActionId) : null;

            let currentDate = new Date(from);
            const endDate = new Date(to);

            while(currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const count = action?.dailyCounts[dateStr] || 0;
                const dayLabel = currentDate.toLocaleDateString('cs-CZ', { weekday: 'short', day: 'numeric', month: 'numeric' });
                planActionDailyCounts.innerHTML += `
                    <div class="form-row">
                        <label style="flex-basis: 150px;">${dayLabel}</label>
                        <div class="form-field"><input type="number" class="plan-day-count" data-date="${dateStr}" value="${count}" min="0"></div>
                    </div>
                `;
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }
        
        function openDayDetailsModal(date) {
            DOMElements.dayDetailsTitle.textContent = new Date(date + 'T00:00:00').toLocaleDateString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'long' });
            const body = DOMElements.dayDetailsBody;
            body.innerHTML = '';
            
            const dayActions = appState.plannedActions.filter(a => date >= a.startDate && date <= a.endDate);
            const dayOrders = appState.orders.filter(o => o.date === date);

            if (dayActions.length === 0 && dayOrders.length === 0) {
                body.innerHTML = '<p>Žádné události pro tento den.</p>';
            } else {
                if (dayActions.length > 0) {
                    body.innerHTML += '<h3>Naplánované akce</h3>';
                    dayActions.forEach(action => {
                        const customer = appState.zakaznici.find(c => c.id === action.customerId);
                        const product = appState.suroviny.find(s => s.id === action.surovinaId);
                        body.innerHTML += `
                            <div class="card" style="padding: 10px; margin-bottom: 10px;">
                                <strong>${product.name}</strong> pro ${customer.name} (${action.dailyCounts[date]} beden)
                                <div class="actions" style="float: right;">
                                    <button class="btn-icon" data-action="edit-action" data-action-id="${action.id}">${ICONS.edit}</button>
                                    <button class="btn-icon danger" data-action="delete-action" data-action-id="${action.id}">${ICONS.trash}</button>
                                </div>
                            </div>
                        `;
                    });
                }
                 if (dayOrders.length > 0) {
                    body.innerHTML += '<h3>Standardní objednávky</h3><p>Upravujte v záložce Objednávky.</p>';
                 }
            }
            DOMElements.dayDetailsModal.classList.add('active');
        }

        // --- SAVE & UPDATE FUNCTIONS ---
        function saveAddedItems() {
            const customerId = appState.ui.addingToCustomerId;
            if (!customerId) return;

            let order = appState.orders.find(o => o.customerId === customerId && o.date === appState.ui.selectedDate);
            if (!order) {
                order = { id: generateId(), date: appState.ui.selectedDate, customerId, items: [] };
                appState.orders.push(order);
            }
            
            document.querySelectorAll('.add-order-box-count').forEach(input => {
                const boxCount = parseInt(input.value);
                if (boxCount > 0) {
                    const surovinaId = input.dataset.surovinaId;
                    order.items.push({ id: generateId(), surovinaId, boxCount });
                }
            });

            saveState();
            renderOrders();
            DOMElements.addOrderModal.classList.remove('active');
            showToast('Položky přidány do objednávky');
        }

        function deleteOrderItem(orderId, itemId) {
            const order = appState.orders.find(o => o.id === orderId);
            if (order) {
                order.items = order.items.filter(i => i.id !== itemId);
                if (order.items.length === 0) {
                    appState.orders = appState.orders.filter(o => o.id !== orderId);
                }
            }
            saveState();
            renderOrders();
        }

        function saveAllBoxWeights() {
            document.querySelectorAll('.box-weight-input').forEach(input => {
                const { customerId, surovinaId } = input.dataset;
                if (!appState.boxWeights[customerId]) appState.boxWeights[customerId] = {};
                appState.boxWeights[customerId][surovinaId] = parseFloat(input.value) || 0;
            });
            saveState();
            showToast('Váhy beden uloženy');
        }

        function saveAllPaletteWeights() {
            document.querySelectorAll('.palette-weight-input').forEach(input => {
                const surovina = appState.suroviny.find(s => s.id === input.dataset.surovinaId);
                if (surovina) surovina.paletteWeight = parseFloat(input.value) || 0;
            });
            saveState();
            showToast('Váhy palet uloženy');
        }

        function saveNewProduct() {
            const name = DOMElements.newProductName.value.trim().toUpperCase();
            if (!name) { showToast('Zadejte název mixu.', 'error'); return; }

            const isEditing = !!appState.ui.editingMixId;
            if (!isEditing && appState.suroviny.some(s => s.name === name)) {
                showToast('Produkt s tímto názvem již existuje.', 'error'); return;
            }

            const components = [];
            let totalPercentage = 0;
            document.querySelectorAll('#new-product-components .form-row').forEach(row => {
                const select = row.querySelector('.new-product-component-surovina');
                const percentageInput = row.querySelector('.new-product-component-percentage');
                const lossInput = row.querySelector('.new-product-component-loss');
                const percentage = parseFloat(percentageInput.value) || 0;
                const loss = parseFloat(lossInput.value) || 0;
                if (percentage > 0) {
                    components.push({ surovinaId: select.value, percentage, loss });
                    totalPercentage += percentage;
                }
            });

            if (components.length === 0) { showToast('Mix musí mít alespoň jednu složku.', 'error'); return; }
            if (Math.abs(totalPercentage - 100) > 0.1) { showToast('Součet podílů musí být 100%.', 'error'); return; }

            if (isEditing) {
                const mixProduct = appState.suroviny.find(s => s.id === appState.ui.editingMixId);
                mixProduct.name = name;
                appState.mixDefinitions[appState.ui.editingMixId].components = components;
                showToast('Mix upraven');
            } else {
                const newMixId = generateId();
                const newMixProduct = { id: newMixId, name, paletteWeight: 0, stock: 0, isMix: true };
                appState.suroviny.push(newMixProduct);
                appState.mixDefinitions[newMixId] = { components };
                
                appState.zakaznici.forEach(c => {
                    if (!appState.boxWeights[c.id]) appState.boxWeights[c.id] = {};
                    appState.boxWeights[c.id][newMixId] = 10000;
                });
                showToast('Nový mix uložen');
            }

            saveState();
            cancelEditMix();
            renderCreateMix();
        }
        
        function saveMixRatio() {
            const itemId = appState.ui.editingOrderItemId;
            const order = appState.orders.find(o => o.items.some(i => i.id === itemId));
            const item = order?.items.find(i => i.id === itemId);
            if (!item) return;

            const newRatios = [];
            let total = 0;
            document.querySelectorAll('#mix-ratio-modal-body .mix-ratio-percentage').forEach(input => {
                const percentage = parseFloat(input.value) || 0;
                total += percentage;
                newRatios.push({ surovinaId: input.dataset.surovinaId, percentage });
            });

            if (Math.abs(total - 100) > 0.1) { showToast('Součet musí být 100%', 'error'); return; }

            item.ratioOverride = newRatios;
            saveState();
            DOMElements.mixRatioModal.classList.remove('active');
            showToast('Poměr pro objednávku upraven');
        }

        function savePlannedAction() {
            const { planActionCustomer, planActionProduct, planActionFrom, planActionTo } = DOMElements;
            const dailyCounts = {};
            document.querySelectorAll('.plan-day-count').forEach(input => {
                const count = parseInt(input.value);
                if (count > 0) {
                    dailyCounts[input.dataset.date] = count;
                }
            });

            if (Object.keys(dailyCounts).length === 0) {
                showToast('Zadejte počet beden alespoň pro jeden den.', 'error');
                return;
            }

            if (appState.ui.editingActionId) {
                const action = appState.plannedActions.find(a => a.id === appState.ui.editingActionId);
                action.customerId = planActionCustomer.value;
                action.surovinaId = planActionProduct.value;
                action.startDate = planActionFrom.value;
                action.endDate = planActionTo.value;
                action.dailyCounts = dailyCounts;
                showToast('Akce upravena');
            } else {
                appState.plannedActions.push({
                    id: generateId(),
                    customerId: planActionCustomer.value,
                    surovinaId: planActionProduct.value,
                    startDate: planActionFrom.value,
                    endDate: planActionTo.value,
                    dailyCounts
                });
                showToast('Akce naplánována');
            }
            saveState();
            DOMElements.planActionModal.classList.remove('active');
            if(appState.ui.activeView === 'calendar') renderCalendar();
            if(appState.ui.activeView === 'daily-plan') renderDailyPlan();
        }

        function deletePlannedAction(actionId) {
            if (confirm('Opravdu chcete smazat tuto naplánovanou akci?')) {
                appState.plannedActions = appState.plannedActions.filter(a => a.id !== actionId);
                saveState();
                DOMElements.dayDetailsModal.classList.remove('active');
                renderCalendar();
                showToast('Akce smazána', 'error');
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            DOMElements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- INIT ---
        loadState();
        bindEvents();
        render();
    });
    
    // --- PEOPLE CALENDAR SCRIPT ---
    function initPeopleCalendar() {
        if (window.peopleCalendarInitialized) return;
        window.peopleCalendarInitialized = true;

        const container = document.getElementById('people-calendar-container');
        container.innerHTML = `
            <div class="buttons">
              <button id="pc-wheelchairBtn" class="btn">♿ Vozíčkáři</button>
              <button id="pc-peopleBtn" class="btn">👥 Seznam směn</button>
              <button id="pc-addBtn" class="btn btn-success">➕ Přidat do kalendáře</button>
            </div>
            <div class="stats">
              <div class="stat" style="background:#ffd6d6"><h3>Odjezdy</h3><span id="pc-s-odj">0</span></div>
              <div class="stat" style="background:#d6ffd6"><h3>Dovolená</h3><span id="pc-s-dov">0</span></div>
              <div class="stat" style="background:#fff4c4"><h3>Nemoc</h3><span id="pc-s-nem">0</span></div>
            </div>
            <div class="month-bar">
              <button id="pc-prev" class="btn">◄</button>
              <h2 id="pc-lbl"></h2>
              <button id="pc-next" class="btn">►</button>
            </div>
            <div class="calendar" id="pc-cal"></div>
            <div class="summary" id="pc-sum"></div>
            
            <!-- Modals for People Calendar -->
            <div class="modal-overlay" id="pc-overlay">
              <div class="modal">
                <h2>Přidat událost</h2>
                <form id="pc-frm">
                  <label>Typ události</label>
                  <select id="pc-typ"><option>Odjezd</option><option>Dovolená</option><option>Nemoc</option><option>Ranní</option><option>Odpolední</option><option>Noční</option></select>
                  <label>Od</label><input type="date" id="pc-od" required>
                  <label>Do (vol.)</label><input type="date" id="pc-do">
                  <label>Čip</label><input id="pc-chip" required>
                  <label>Pracovní místo</label>
                  <select id="pc-place"><option value="Nezařazené">Nezařazené</option><option value="KFC">KFC</option><option value="Lima">Lima</option></select>
                  <div class="actions">
                    <button type="button" class="cancel btn" id="pc-cls">Zrušit</button>
                    <button type="submit" class="save btn btn-primary">Uložit</button>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-overlay" id="pc-eventModal">
              <div class="modal">
                <h2>Události</h2>
                <div id="pc-eventList"></div>
                <div class="actions">
                  <button class="cancel btn" id="pc-closeEventModal">Zavřít</button>
                </div>
              </div>
            </div>
            <div class="modal-overlay" id="pc-peopleOverlay">
              <div class="modal people-modal">
                <h2>Seznam směn</h2>
                <div class="shifts">
                  <div class="shift">
                    <h3>Směna 1 (<span id="pc-countShift1">0</span>)</h3>
                    <div id="pc-shift1List"></div>
                  </div>
                  <div class="shift">
                    <h3>Směna 2 (<span id="pc-countShift2">0</span>)</h3>
                    <div id="pc-shift2List"></div>
                  </div>
                </div>
                <p id="pc-totalPeople"></p>
                <div class="actions">
                  <button id="pc-addPersonBtn" class="btn btn-success">Přidat osobu</button>
                  <button class="cancel btn" id="pc-closePeople">Zavřít</button>
                </div>
              </div>
            </div>
            <div class="modal-overlay" id="pc-personOverlay">
              <div class="modal">
                <h2>Přidat/Upravit osobu</h2>
                <form id="pc-personFrm">
                  <label>Jméno</label><input id="pc-firstName" required>
                  <label>Příjmení</label><input id="pc-lastName" required>
                  <label>Čip</label><input id="pc-chipPerson" required>
                  <label>Pracovní místo</label>
                  <select id="pc-workPlace"><option value="Nezařazené">Nezařazené</option><option value="KFC">KFC</option></select>
                  <label>Směna</label>
                  <select id="pc-shift"><option value="Směna 1">Směna 1</option><option value="Směna 2">Směna 2</option></select>
                  <div class="actions">
                    <button type="button" class="cancel btn" id="pc-cancelPerson">Zrušit</button>
                    <button type="submit" class="save btn btn-primary">Uložit</button>
                  </div>
                </form>
              </div>
            </div>
        `;
        
        const cal=document.getElementById('pc-cal'),lbl=document.getElementById('pc-lbl');
        let cur=new Date(),ev=JSON.parse(localStorage.getItem("people_events") || "[]"),people=JSON.parse(localStorage.getItem("people_list") || "[]"),editingPersonIndex=-1, editingEventIndex = -1;
        const icons={'Odjezd':'🚗','Dovolená':'🌴','Nemoc':'🤒','Ranní':'☀','Odpolední':'🌇','Noční':'🌙'};
        const stats={'Odjezd':'pc-s-odj','Dovolená':'pc-s-dov','Nemoc':'pc-s-nem'};

        function saveEvents(){localStorage.setItem("people_events",JSON.stringify(ev));}
        function savePeople(){localStorage.setItem("people_list",JSON.stringify(people));}

        function render() {
          cal.innerHTML='';
          const ym=cur.toLocaleString('cs-CZ',{month:'long',year:'numeric'});
          lbl.textContent=ym.charAt(0).toUpperCase()+ym.slice(1);
          const y=cur.getFullYear(),m=cur.getMonth();
          const first=(new Date(y,m,1).getDay()||7)-1;
          const days=new Date(y,m+1,0).getDate();
          ['Po','Út','St','Čt','Pá','So','Ne'].forEach(d=>{const h=document.createElement('div');h.className='dow';h.textContent=d;cal.appendChild(h);});
          for(let i=0;i<42;i++){const cell=document.createElement('div');cell.className='day';
            const d=i-first+1;
            if(i<first||d>days){cell.classList.add('disabled');cal.appendChild(cell);continue;}
            const dateStr=new Date(y,m,d).toISOString().split('T')[0];
            cell.dataset.date=dateStr;
            if((i%7)==5|| (i%7)==6) cell.classList.add('weekend');
            cell.innerHTML=`<span class='date'>${d}</span><div class='tags'></div>`;
            cell.addEventListener('click',()=>show(dateStr));
            cal.appendChild(cell);
          }
          update();
        }

        function update() {
          document.querySelectorAll('#people-calendar-container .tags').forEach(t=>t.textContent='');
          for(const k in stats) document.getElementById(stats[k]).textContent=0;
          const sum={},currentMonth=cur.getFullYear()+'-'+String(cur.getMonth()+1).padStart(2,'0');
          ev.forEach(e=>{
            const eventMonth=e.date.slice(0,7);
            if(eventMonth===currentMonth){
              const tg=document.querySelector(`#people-calendar-container [data-date='${e.date}'] .tags`);if(tg) tg.textContent+=icons[e.typ] || '';
              if (stats[e.typ]) document.getElementById(stats[k]).textContent=+document.getElementById(stats[k]).textContent+1;
              if(e.place) sum[e.place]=(sum[e.place]||0)+1;
            }
          });
          const s=document.getElementById('pc-sum');s.innerHTML='';
          for(const p in sum){const div=document.createElement('div');div.className='post';div.textContent=`${p}: ${sum[p]}`;s.appendChild(div);}
        }

        function show(d) {
          const list=ev.filter(e=>e.date===d);
          const eventList = document.getElementById('pc-eventList');
          eventList.innerHTML = list.length ? list.map((e, idx) => `<div class="event-item"><span>${e.chip} – ${e.typ}</span></div>`).join('') : '<p>Žádné události tento den</p>';
          document.getElementById('pc-eventModal').style.display = 'flex';
        }
        
        function showPeople() {
            const shift1=people.filter(p=>p.shift==='Směna 1'),shift2=people.filter(p=>p.shift==='Směna 2');
            document.getElementById('pc-shift1List').innerHTML=shift1.length?shift1.map((p,idx)=>{const globalIdx=people.indexOf(p);return`<div class="person-item"><span>${p.firstName} ${p.lastName} (${p.chipPerson}) - ${p.workPlace}</span><div><button class="edit" onclick="window.pcFunctions.editPerson(${globalIdx})">Upravit</button><button class="delete" onclick="window.pcFunctions.deletePerson(${globalIdx})">Odebrat</button></div></div>`;}).join(''):'<p>Žádní lidé</p>';
            document.getElementById('pc-shift2List').innerHTML=shift2.length?shift2.map((p,idx)=>{const globalIdx=people.indexOf(p);return`<div class="person-item"><span>${p.firstName} ${p.lastName} (${p.chipPerson}) - ${p.workPlace}</span><div><button class="edit" onclick="window.pcFunctions.editPerson(${globalIdx})">Upravit</button><button class="delete" onclick="window.pcFunctions.deletePerson(${globalIdx})">Odebrat</button></div></div>`;}).join(''):'<p>Žádní lidé</p>';
            document.getElementById('pc-countShift1').textContent=shift1.length;
            document.getElementById('pc-countShift2').textContent=shift2.length;
            document.getElementById('pc-totalPeople').textContent=`Celkem: ${people.length}`;
            document.getElementById('pc-peopleOverlay').style.display='flex';
        }

        window.pcFunctions = {
            editPerson: (index) => {
              editingPersonIndex=index;
              const p=people[index];
              document.getElementById('pc-firstName').value=p.firstName;
              document.getElementById('pc-lastName').value=p.lastName;
              document.getElementById('pc-chipPerson').value=p.chipPerson;
              document.getElementById('pc-workPlace').value=p.workPlace;
              document.getElementById('pc-shift').value=p.shift;
              document.getElementById('pc-personOverlay').style.display='flex';
            },
            deletePerson: (index) => {
              if(confirm('Opravdu odebrat?')){
                const deletedChip = people[index].chipPerson;
                ev = ev.filter(e => e.chip !== deletedChip);
                people.splice(index,1);
                savePeople();
                saveEvents();
                showPeople();
                update();
              }
            }
        };
        
        document.getElementById('pc-prev').onclick=()=>{cur.setMonth(cur.getMonth()-1);render();};
        document.getElementById('pc-next').onclick=()=>{cur.setMonth(cur.getMonth()+1);render();};
        document.getElementById('pc-addBtn').onclick=()=>document.getElementById('pc-overlay').style.display='flex';
        document.getElementById('pc-cls').onclick=()=>document.getElementById('pc-overlay').style.display='none';
        document.getElementById('pc-frm').onsubmit=e=>{e.preventDefault();
            const data={typ:document.getElementById('pc-typ').value,od:document.getElementById('pc-od').value,
                       do:document.getElementById('pc-do').value,chip:document.getElementById('pc-chip').value,place:document.getElementById('pc-place').value};
            if(!data.od||!data.chip){alert('Vyplň povinná pole');return;}
            ev.push({...data,date:data.od});
            saveEvents();
            document.getElementById('pc-overlay').style.display='none';
            e.target.reset();update();
        };
        document.getElementById('pc-closeEventModal').onclick = () => document.getElementById('pc-eventModal').style.display = 'none';
        document.getElementById('pc-peopleBtn').onclick=showPeople;
        document.getElementById('pc-closePeople').onclick=()=>document.getElementById('pc-peopleOverlay').style.display='none';
        document.getElementById('pc-addPersonBtn').onclick=()=>{editingPersonIndex=-1;document.getElementById('pc-personFrm').reset();document.getElementById('pc-personOverlay').style.display='flex';};
        document.getElementById('pc-cancelPerson').onclick=()=>document.getElementById('pc-personOverlay').style.display='none';
        document.getElementById('pc-personFrm').onsubmit=e=>{e.preventDefault();
          const data={firstName:document.getElementById('pc-firstName').value,lastName:document.getElementById('pc-lastName').value,chipPerson:document.getElementById('pc-chipPerson').value,workPlace:document.getElementById('pc-workPlace').value,shift:document.getElementById('pc-shift').value};
          if(!data.firstName||!data.lastName||!data.chipPerson){alert('Vyplň povinná pole');return;}
          if(editingPersonIndex>=0){people[editingPersonIndex]=data;}else{people.push(data);}
          savePeople();
          document.getElementById('pc-personOverlay').style.display='none';
          e.target.reset();showPeople();
        };
        
        render();
    }
    </script>
</body>
</html>
