<!DOCTYPE html>
<html lang="cs" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DZ Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #eef2f7;
            --text-primary: #1a202c;
            --text-secondary: #5a677d;
            --border-color: #dbe1e8;
            --accent-primary: #3498db;
            --accent-primary-hover: #2980b9;
            --accent-danger: #e74c3c;
            --accent-danger-hover: #c0392b;
            --accent-success: #2ecc71;
            --accent-success-hover: #27ae60;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: 'Inter', sans-serif;
            --shift-morning: #f1c40f;
            --shift-afternoon: #e67e22;
            --shift-night: #34495e;
        }

        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #252d3b;
            --text-primary: #edf2f7;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --accent-primary: #4299e1;
            --accent-primary-hover: #63b3ed;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #app-nav {
            width: 260px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }

        #app-main {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .nav-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 30px; }
        .nav-links a, .nav-links summary {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
        }
        .nav-links a.active { background-color: var(--accent-primary); color: white; }
        .nav-links a:not(.active):hover, .nav-links summary:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .nav-links details[open] summary { background-color: var(--bg-tertiary); }
        .nav-links .submenu a { padding-left: 42px; font-size: 0.9em; margin-bottom: 4px; }
        .nav-links summary { list-style: none; }
        .nav-links summary::-webkit-details-marker { display: none; }
        .nav-links summary::after {
            content: '▶';
            font-size: 0.6em;
            margin-left: auto;
            transition: transform 0.2s;
        }
        .nav-links details[open] summary::after { transform: rotate(90deg); }


        .nav-footer { margin-top: auto; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 1rem;
            font-family: var(--font-family);
        }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }
        .form-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        .form-field { flex: 1; min-width: 150px; }

        .page { display: none; }
        .page.active { display: block; }
        .page-header { font-size: 2rem; font-weight: 700; margin-bottom: 25px; }
        .page-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }

        .card {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 25px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .card-title { font-size: 1.25rem; font-weight: 600; }

        .btn {
            padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
            font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:hover { background-color: var(--accent-primary-hover); }
        .btn-success { background-color: var(--accent-success); color: white; }
        .btn-success:hover { background-color: var(--accent-success-hover); }
        .btn-danger { background-color: var(--accent-danger); color: white; }
        .btn-danger:hover { background-color: var(--accent-danger-hover); }
        .btn-icon { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background-color: var(--bg-tertiary); }
        .btn-icon svg { width: 20px; height: 20px; stroke: var(--text-secondary); }
        .btn-icon.danger:hover svg { stroke: var(--accent-danger); }

        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th, .data-table td { padding: 8px 6px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table .actions { text-align: right; }
        .shortage { color: var(--accent-danger); font-weight: 600; }
        .surplus { color: var(--accent-success); font-weight: 600; }

        .accordion details { margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; }
        .accordion summary {
            padding: 15px; font-weight: 600; cursor: pointer; list-style: none;
            display: flex; justify-content: space-between; align-items: center;
        }
        .accordion summary::-webkit-details-marker { display: none; }
        .accordion summary::after { content: '+'; font-size: 1.5rem; }
        .accordion details[open] summary { border-bottom: 1px solid var(--border-color); }
        .accordion details[open] summary::after { content: '−'; }
        .accordion .details-content { padding: 15px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 700px; }
        .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: var(--shadow); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 2.5s forwards; }
        .toast.success { background-color: var(--accent-success); }
        .toast.error { background-color: var(--accent-danger); }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; } }

        /* Calendar Styles */
        .calendar-toolbar { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        #current-month-display, #pc-current-month-display { font-size: 1.5rem; font-weight: 600; text-align: center; flex-grow: 1; }
        .calendar-grid { display: grid; grid-template-columns: 50px repeat(7, 1fr); gap: 5px; }
        .calendar-header { text-align: center; font-weight: 600; color: var(--text-secondary); padding-bottom: 10px; }
        .week-number { font-weight: bold; color: var(--accent-primary); display: flex; align-items: center; justify-content: center; }
        .calendar-day { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; min-height: 100px; padding: 8px; position: relative; cursor: pointer; transition: box-shadow 0.2s; }
        .calendar-day:hover { box-shadow: var(--shadow); }
        .day-number { font-weight: 600; margin-bottom: 5px; }
        .day-items { display: flex; flex-direction: column; gap: 4px; font-size: 0.75rem; }
        .day-pill { background-color: var(--accent-primary); color: white; padding: 2px 5px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .day-pill.is-order { background-color: var(--accent-success); }
        
        /* People Calendar Specific Styles */
        .pc-shifts-container { display: flex; gap: 20px; }
        .pc-shift-column { flex: 1; }
        .pc-person-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .pc-person-info { font-size: 0.9rem; }
        .pc-person-info small { color: var(--text-secondary); display: block; }
        
        /* Wheelchair Calendar */
        .wc-calendar-container { display: grid; grid-template-columns: 100px repeat(7, 1fr); gap: 1px; background-color: var(--border-color); border: 1px solid var(--border-color); }
        .wc-header-cell, .wc-shift-cell, .wc-day-cell { background-color: var(--bg-secondary); padding: 8px; }
        .wc-header-cell { text-align: center; font-weight: 600; }
        .wc-shift-cell { font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .wc-day-cell { min-height: 120px; }
        .wc-user-pill { background-color: var(--accent-primary); color: white; padding: 5px 8px; border-radius: 6px; margin-bottom: 5px; font-size: 0.85rem; cursor: grab; }
        .wc-user-pill.dragging { opacity: 0.5; }
        .wc-user-pill.morning { background-color: var(--shift-morning); color: var(--text-primary); }
        .wc-user-pill.afternoon { background-color: var(--shift-afternoon); }
        .wc-user-pill.night { background-color: var(--shift-night); }
        .wc-user-pill.vacation { background-color: var(--accent-danger); text-decoration: line-through; }
    </style>
</head>
<body>

    <nav id="app-nav">
        <div>
            <div class="nav-header">DZ Control</div>
            <div class="nav-links">
                <a href="#" class="nav-link active" data-view="daily-plan"><span>Denní Plán</span></a>
                <a href="#" class="nav-link" data-view="orders"><span>Objednávky</span></a>
                <a href="#" class="nav-link" data-view="calendar"><span>Kalendář akcí</span></a>
                <a href="#" class="nav-link" data-view="zamestnanci"><span>Zaměstnanci</span></a>
                <a href="#" class="nav-link" data-view="kfc"><span>KFC</span></a>
                <a href="#" class="nav-link" data-view="zmeny"><span>Změny</span></a>
                <details>
                    <summary>Nastavení</summary>
                    <div class="submenu">
                        <a href="#" class="nav-link" data-view="create-product"><span>Vytvořit produkt</span></a>
                        <a href="#" class="nav-link" data-view="create-mix"><span>Vytvořit mix</span></a>
                        <a href="#" class="nav-link" data-view="box-weights"><span>Váhy beden</span></a>
                        <a href="#" class="nav-link" data-view="palette-weights"><span>Váhy palet</span></a>
                    </div>
                </details>
            </div>
        </div>
        <div class="nav-footer">
            <div class="form-group">
                <label for="selectedDate">Datum plánu</label>
                <input type="date" id="selectedDate">
            </div>
        </div>
    </nav>

    <main id="app-main">
        <!-- 1. Denní Plán View -->
        <div id="view-daily-plan" class="page active">
            <h1 class="page-header">Denní Plán</h1>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Přehled Surovin na Den (mimo KFC)</h2></div>
                <div class="card-content">
                    <table class="data-table" id="suroviny-overview-table">
                        <thead><tr><th>Surovina</th><th>Skladem (palet)</th><th>Potřeba (kg)</th><th>Chybí / Přebývá (palet)</th><th>Následující den (kg)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Kalibr</h2></div>
                <div class="card-content" id="kalibr-table-container">
                    <!-- Kalibr table will be rendered here -->
                </div>
            </div>
        </div>

        <!-- 2. Objednávky View -->
        <div id="view-orders" class="page">
            <h1 class="page-header">Objednávky</h1>
            <div class="accordion" id="orders-accordion"></div>
        </div>
        
        <!-- 3. Kalendář akcí View -->
        <div id="view-calendar" class="page">
            <h1 class="page-header">Kalendář akcí</h1>
            <div class="card">
                 <div class="calendar-toolbar">
                     <button id="prev-month-btn" class="btn btn-primary">Předchozí</button>
                     <div id="current-month-display"></div>
                     <button id="next-month-btn" class="btn btn-primary">Další</button>
                     <button id="plan-action-btn" class="btn btn-success">+ Přidat akci</button>
                 </div>
                 <div class="calendar-grid" id="calendar-grid">
                    <!-- JS generated content -->
                 </div>
            </div>
        </div>
        
        <!-- 4. Zaměstnanci View -->
        <div id="view-zamestnanci" class="page">
             <div class="page-header-container">
                <h1 class="page-header" style="margin-bottom: 0;">Zaměstnanci</h1>
                <button class="btn btn-primary" data-action="open-wheelchair-calendar">Vozíčkáři</button>
             </div>
             <div class="card">
                 <div class="calendar-toolbar">
                     <button id="pc-prev-month-btn" class="btn btn-primary">Předchozí</button>
                     <div id="pc-current-month-display"></div>
                     <button id="pc-next-month-btn" class="btn btn-primary">Další</button>
                     <button id="pc-show-shifts-btn" class="btn btn-success">Seznam směn</button>
                 </div>
                 <div class="calendar-grid" id="pc-calendar-grid"></div>
             </div>
        </div>

        <!-- 5. Váhy Beden View -->
        <div id="view-box-weights" class="page">
            <h1 class="page-header">Váhy beden dle zákazníka</h1>
            <div class="card">
                <div class="accordion" id="box-weights-accordion"></div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" id="save-all-box-weights-btn">Uložit všechny změny</button>
                </div>
            </div>
        </div>

        <!-- 6. Vytvořit Mix View -->
        <div id="view-create-mix" class="page">
            <h1 class="page-header" id="create-mix-header">Vytvořit nový mix</h1>
            <div class="card">
                <div class="form-row">
                    <div class="form-field"><label for="new-product-name">Název mixu</label><input type="text" id="new-product-name"></div>
                </div>
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <h3>Složení mixu</h3>
                <div id="new-product-components"></div>
                <button class="btn btn-success" id="add-new-product-component-btn" style="margin-top: 10px;">+ Přidat surovinu</button>
                <div style="font-weight: bold; margin-top: 15px;">Celkem: <span id="new-product-total-percentage">0</span>%</div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" id="save-new-product-btn">Uložit mix</button>
                    <button class="btn" id="cancel-edit-mix-btn" style="display: none;">Zrušit úpravu</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2 class="card-title">Existující mixy</h2></div>
                <div class="card-content">
                    <table class="data-table" id="existing-mixes-table">
                        <thead><tr><th>Název mixu</th><th>Složení</th><th class="actions">Akce</th></tr></thead>
                        <tbody id="existing-mixes-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 7. Váhy Palet View -->
        <div id="view-palette-weights" class="page">
            <h1 class="page-header">Váhy palet</h1>
            <div class="card">
                <table class="data-table" id="palette-weights-table">
                    <thead><tr><th>Surovina</th><th>Váha palety (kg)</th></tr></thead>
                    <tbody id="palette-weights-table-body"></tbody>
                </table>
                 <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" id="save-all-palette-weights-btn">Uložit všechny změny</button>
                </div>
            </div>
        </div>
        
        <!-- 8. KFC View -->
        <div id="view-kfc" class="page">
            <h1 class="page-header">KFC Plán</h1>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Přehled Surovin na Den (pouze KFC)</h2></div>
                <div class="card-content">
                    <table class="data-table" id="kfc-overview-table">
                        <thead><tr><th>Surovina</th><th>Potřeba (kg)</th><th>Následující den (kg)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 9. Změny View -->
        <div id="view-zmeny" class="page">
            <div class="page-header-container">
                <h1 class="page-header" style="margin-bottom: 0;">Změny</h1>
                <button class="btn btn-success" data-action="add-change">+ Přidat změnu</button>
            </div>
            <div class="card">
                <table class="data-table" id="changes-table">
                    <thead><tr><th>Platnost od</th><th>Platnost do</th><th>Nadpis</th><th>Popis</th><th class="actions">Akce</th></tr></thead>
                    <tbody id="changes-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 10. Vytvořit Produkt View -->
        <div id="view-create-product" class="page">
            <h1 class="page-header" id="create-product-header">Vytvořit nový produkt</h1>
            <div class="card">
                <div class="form-row">
                    <div class="form-field"><label for="new-prod-name">Název produktu</label><input type="text" id="new-prod-name"></div>
                    <div class="form-field"><label for="new-prod-customer">Zákazník</label><select id="new-prod-customer"></select></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="new-prod-surovina">Surovina</label><select id="new-prod-surovina"></select></div>
                    <div class="form-field"><label for="new-prod-box-weight">Váha bedny (g)</label><input type="number" id="new-prod-box-weight"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="new-prod-marinade-name">Název marinády (nepovinné)</label><input type="text" id="new-prod-marinade-name"></div>
                    <div class="form-field"><label for="new-prod-marinade-percent">Marináda % (nepovinné)</label><input type="number" id="new-prod-marinade-percent"></div>
                    <div class="form-field"><label for="new-prod-loss-percent">Ztráta % (nepovinné)</label><input type="number" id="new-prod-loss-percent"></div>
                </div>
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <h3>Kalibrace</h3>
                 <div class="form-row">
                    <div class="form-field"><label for="new-prod-calibrated-surovina">Kalibrovaná surovina</label><select id="new-prod-calibrated-surovina"></select></div>
                    <div class="form-field"><label for="new-prod-calibrated-weight">Váha (g) od-do</label><input type="text" id="new-prod-calibrated-weight" placeholder="např. 80-100"></div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" id="save-new-prod-btn">Uložit produkt</button>
                    <button class="btn" id="cancel-edit-prod-btn" style="display: none;">Zrušit úpravu</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Existující produkty</h2></div>
                <div class="card-content">
                    <table class="data-table" id="existing-products-table">
                        <thead><tr><th>Název</th><th>Zákazník</th><th>Surovina</th><th>Váha bedny (g)</th><th class="actions">Akce</th></tr></thead>
                        <tbody id="existing-products-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 11. Wheelchair Calendar View -->
        <div id="view-wheelchair-calendar" class="page">
            <div class="page-header-container">
                <h1 class="page-header" style="margin-bottom: 0;">Plán Vozíčkářů</h1>
                <div>
                    <button class="btn btn-success" data-action="wc-add-user">+ Přidat vozíčkáře</button>
                    <button class="btn btn-primary" data-action="wc-show-user-list">Seznam vozíčkářů</button>
                </div>
            </div>
            <div class="card">
                <div class="calendar-toolbar">
                    <button id="wc-prev-week-btn" class="btn btn-primary">Předchozí týden</button>
                    <div id="wc-current-week-display" style="font-size: 1.5rem; font-weight: 600; text-align: center; flex-grow: 1;"></div>
                    <button id="wc-next-week-btn" class="btn btn-primary">Následující týden</button>
                </div>
                <div id="wc-calendar-container" class="wc-calendar-container"></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="add-change-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="add-change-modal-title">Přidat změnu</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-field">
                        <label for="change-date-from">Platnost od</label>
                        <input type="date" id="change-date-from">
                    </div>
                    <div class="form-field">
                        <label for="change-date-to">Platnost do (nepovinné)</label>
                        <input type="date" id="change-date-to">
                    </div>
                </div>
                <div class="form-group">
                    <label for="change-title">Nadpis</label>
                    <input type="text" id="change-title" placeholder="Stručný popis změny">
                </div>
                <div class="form-group">
                    <label for="change-text">Text změny</label>
                    <textarea id="change-text" placeholder="Detailní popis změny..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zrušit</button>
                <button class="btn btn-primary" id="save-change-btn">Uložit změnu</button>
            </div>
        </div>
    </div>
    
    <div id="mix-ratio-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="mix-ratio-modal-title">Upravit poměr surovin</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="mix-ratio-modal-body"></div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zrušit</button>
                <button class="btn btn-primary" id="save-mix-ratio-btn">Uložit poměr</button>
            </div>
        </div>
    </div>

    <div id="add-order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="add-order-modal-title">Přidat položky do objednávky</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="add-order-modal-body"></div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zrušit</button>
                <button class="btn btn-primary" id="save-added-items-btn">Přidat do objednávky</button>
            </div>
        </div>
    </div>

    <div id="plan-action-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="plan-action-modal-title">Naplánovat akci</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-field"><label>Zákazník</label><select id="plan-action-customer"></select></div>
                    <div class="form-field"><label>Produkt</label><select id="plan-action-product"></select></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label>Od</label><input type="date" id="plan-action-from"></div>
                    <div class="form-field"><label>Do</label><input type="date" id="plan-action-to"></div>
                </div>
                <div id="plan-action-daily-counts"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zrušit</button>
                <button class="btn btn-primary" id="save-planned-action-btn">Uložit akci</button>
            </div>
        </div>
    </div>
    
    <div id="day-details-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="day-details-title">Detail dne</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="day-details-body"></div>
        </div>
    </div>
    
    <!-- People Calendar Modals -->
    <div id="pc-shifts-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Seznam směn</h2>
                <button class="btn btn-success" id="pc-add-person-btn" data-action="pc-add-person">Přidat osobu</button>
            </div>
            <div class="modal-body pc-shifts-container">
                <div class="pc-shift-column">
                    <h3>1. směna (<span id="pc-shift1-count">0</span>)</h3>
                    <div id="pc-shift1-list"></div>
                </div>
                <div class="pc-shift-column">
                    <h3>2. směna (<span id="pc-shift2-count">0</span>)</h3>
                    <div id="pc-shift2-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zavřít</button>
            </div>
        </div>
    </div>
    
    <div id="pc-person-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="pc-person-modal-title">Přidat osobu</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-field"><label for="pc-person-firstname">Jméno</label><input type="text" id="pc-person-firstname"></div>
                    <div class="form-field"><label for="pc-person-lastname">Příjmení</label><input type="text" id="pc-person-lastname"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="pc-person-chip">Čip</label><input type="text" id="pc-person-chip"></div>
                    <div class="form-field"><label for="pc-person-phone">Telefon (nepovinné)</label><input type="tel" id="pc-person-phone"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="pc-person-shift">Směna</label><select id="pc-person-shift"><option value="1">1. směna</option><option value="2">2. směna</option></select></div>
                    <div class="form-field"><label for="pc-person-gender">Pohlaví</label><select id="pc-person-gender"><option value="muz">Muž</option><option value="zena">Žena</option></select></div>
                </div>
                <div class="form-group">
                    <label for="pc-person-position">Pracovní místo</label>
                    <select id="pc-person-position"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zrušit</button>
                <button class="btn btn-primary" id="pc-save-person-btn">Uložit</button>
            </div>
        </div>
    </div>

    <!-- Wheelchair Modals -->
    <div id="wc-user-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="wc-user-modal-title">Přidat vozíčkáře</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-field"><label for="wc-user-firstname">Jméno</label><input type="text" id="wc-user-firstname"></div>
                    <div class="form-field"><label for="wc-user-lastname">Příjmení</label><input type="text" id="wc-user-lastname"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="wc-user-chip">Čip</label><input type="text" id="wc-user-chip"></div>
                    <div class="form-field"><label for="wc-user-phone">Telefon (nepovinné)</label><input type="tel" id="wc-user-phone"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-action="close-modal">Zrušit</button>
                <button class="btn btn-primary" id="wc-save-user-btn">Uložit</button>
            </div>
        </div>
    </div>
    
    <div id="wc-user-list-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Seznam vozíčkářů</h2>
                <button class="btn-icon" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <table class="data-table">
                    <thead><tr><th>Jméno</th><th>Čip</th><th>Telefon</th><th class="actions">Akce</th></tr></thead>
                    <tbody id="wc-user-list-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title" id="confirmation-modal-title">Potvrdit akci</h2>
            </div>
            <div class="modal-body" id="confirmation-modal-body">
                <p>Opravdu si přejete pokračovat?</p>
            </div>
            <div class="modal-footer">
                <button class="btn" id="confirmation-cancel-btn">Zrušit</button>
                <button class="btn btn-danger" id="confirmation-confirm-btn">Potvrdit</button>
            </div>
        </div>
    </div>


    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ICONS & GLOBAL VARS ---
        const ICONS = {
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>`,
        };
        let appState = {};
        const DOMElements = {
            navLinks: document.querySelectorAll('.nav-link'),
            views: document.querySelectorAll('.page'),
            selectedDateInput: document.getElementById('selectedDate'),
            surovinyOverviewTableBody: document.querySelector('#suroviny-overview-table tbody'),
            kfcOverviewTableBody: document.querySelector('#kfc-overview-table tbody'),
            kalibrTableContainer: document.getElementById('kalibr-table-container'),
            ordersAccordion: document.getElementById('orders-accordion'),
            calendarGrid: document.getElementById('calendar-grid'),
            currentMonthDisplay: document.getElementById('current-month-display'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            planActionBtn: document.getElementById('plan-action-btn'),
            boxWeightsAccordion: document.getElementById('box-weights-accordion'),
            saveAllBoxWeightsBtn: document.getElementById('save-all-box-weights-btn'),
            createMixHeader: document.getElementById('create-mix-header'),
            newProductName: document.getElementById('new-product-name'),
            newProductComponents: document.getElementById('new-product-components'),
            addNewProductComponentBtn: document.getElementById('add-new-product-component-btn'),
            newProductTotalPercentage: document.getElementById('new-product-total-percentage'),
            saveNewProductBtn: document.getElementById('save-new-product-btn'),
            cancelEditMixBtn: document.getElementById('cancel-edit-mix-btn'),
            existingMixesTableBody: document.getElementById('existing-mixes-table-body'),
            paletteWeightsTableBody: document.getElementById('palette-weights-table-body'),
            saveAllPaletteWeightsBtn: document.getElementById('save-all-palette-weights-btn'),
            // Create Product
            createProductHeader: document.getElementById('create-product-header'),
            newProdName: document.getElementById('new-prod-name'),
            newProdCustomer: document.getElementById('new-prod-customer'),
            newProdSurovina: document.getElementById('new-prod-surovina'),
            newProdBoxWeight: document.getElementById('new-prod-box-weight'),
            newProdMarinadeName: document.getElementById('new-prod-marinade-name'),
            newProdMarinadePercent: document.getElementById('new-prod-marinade-percent'),
            newProdLossPercent: document.getElementById('new-prod-loss-percent'),
            newProdCalibratedSurovina: document.getElementById('new-prod-calibrated-surovina'),
            newProdCalibratedWeight: document.getElementById('new-prod-calibrated-weight'),
            saveNewProdBtn: document.getElementById('save-new-prod-btn'),
            cancelEditProdBtn: document.getElementById('cancel-edit-prod-btn'),
            existingProductsTableBody: document.getElementById('existing-products-table-body'),
            // Changes
            changesTableBody: document.getElementById('changes-table-body'),
            addChangeModal: document.getElementById('add-change-modal'),
            addChangeModalTitle: document.getElementById('add-change-modal-title'),
            changeDateFrom: document.getElementById('change-date-from'),
            changeDateTo: document.getElementById('change-date-to'),
            changeTitle: document.getElementById('change-title'),
            changeText: document.getElementById('change-text'),
            saveChangeBtn: document.getElementById('save-change-btn'),
            // Modals
            mixRatioModal: document.getElementById('mix-ratio-modal'),
            mixRatioModalTitle: document.getElementById('mix-ratio-modal-title'),
            mixRatioModalBody: document.getElementById('mix-ratio-modal-body'),
            saveMixRatioBtn: document.getElementById('save-mix-ratio-btn'),
            addOrderModal: document.getElementById('add-order-modal'),
            addOrderModalTitle: document.getElementById('add-order-modal-title'),
            addOrderModalBody: document.getElementById('add-order-modal-body'),
            saveAddedItemsBtn: document.getElementById('save-added-items-btn'),
            planActionModal: document.getElementById('plan-action-modal'),
            planActionModalTitle: document.getElementById('plan-action-modal-title'),
            planActionCustomer: document.getElementById('plan-action-customer'),
            planActionProduct: document.getElementById('plan-action-product'),
            planActionFrom: document.getElementById('plan-action-from'),
            planActionTo: document.getElementById('plan-action-to'),
            planActionDailyCounts: document.getElementById('plan-action-daily-counts'),
            savePlannedActionBtn: document.getElementById('save-planned-action-btn'),
            dayDetailsModal: document.getElementById('day-details-modal'),
            dayDetailsTitle: document.getElementById('day-details-title'),
            dayDetailsBody: document.getElementById('day-details-body'),
            toastContainer: document.getElementById('toast-container'),
            confirmationModal: document.getElementById('confirmation-modal'),
            confirmationModalTitle: document.getElementById('confirmation-modal-title'),
            confirmationModalBody: document.getElementById('confirmation-modal-body'),
            confirmationConfirmBtn: document.getElementById('confirmation-confirm-btn'),
            confirmationCancelBtn: document.getElementById('confirmation-cancel-btn'),
            // Wheelchair Calendar
            wcCalendarContainer: document.getElementById('wc-calendar-container'),
            wcPrevWeekBtn: document.getElementById('wc-prev-week-btn'),
            wcNextWeekBtn: document.getElementById('wc-next-week-btn'),
            wcCurrentWeekDisplay: document.getElementById('wc-current-week-display'),
            wcUserModal: document.getElementById('wc-user-modal'),
            wcUserModalTitle: document.getElementById('wc-user-modal-title'),
            wcUserFirstName: document.getElementById('wc-user-firstname'),
            wcUserLastName: document.getElementById('wc-user-lastname'),
            wcUserChip: document.getElementById('wc-user-chip'),
            wcUserPhone: document.getElementById('wc-user-phone'),
            wcSaveUserBtn: document.getElementById('wc-save-user-btn'),
            wcUserListModal: document.getElementById('wc-user-list-modal'),
            wcUserListTbody: document.getElementById('wc-user-list-tbody'),
        };

        // --- STATE MANAGEMENT ---
        function generateId() { return crypto.randomUUID(); }

        function loadState() {
            const savedState = localStorage.getItem('surovinyAppData_v12');
            if (savedState) {
                appState = JSON.parse(savedState);
            } else {
                setupDefaultData();
            }
            const today = new Date();
            appState.ui = {
                selectedDate: today.toISOString().split('T')[0],
                activeView: 'daily-plan',
                editingOrderItemId: null,
                addingToCustomerId: null,
                editingMixId: null,
                editingProductId: null,
                editingChangeId: null,
                editingActionId: null,
                openAccordionId: null,
                calendar: {
                    year: today.getFullYear(),
                    month: today.getMonth(),
                },
                wheelchairCalendar: {
                    year: today.getFullYear(),
                    week: getWeekNumber(today),
                },
                editingWcUserId: null,
            };
        }

        function saveState() {
            const stateToSave = { ...appState };
            delete stateToSave.ui; 
            localStorage.setItem('surovinyAppData_v12', JSON.stringify(stateToSave));
        }

        function setupDefaultData() {
            appState.suroviny = [
                {id: 's01', name: 'ŘÍZKY'}, {id: 's02', name: 'STRIPS'}, {id: 's03', name: 'PRSA'},
                {id: 's04', name: 'HRBETY'}, {id: 's05', name: 'PRDELE'}, {id: 's06', name: 'HORNÍ STEHNA'},
                {id: 's07', name: 'SPODNÍ STEHNA'}, {id: 's08', name: 'ČTVRTKY'}, {id: 's09', name: 'KŘÍDLA'},
                {id: 's10', name: 'PLACKY'}, {id: 's11', name: 'BANDURY'}, {id: 's12', name: 'STEAK'},
                {id: 's13', name: 'JÁTRA'}, {id: 's14', name: 'SRDCE'}, {id: 's15', name: 'ŽALUDKY'}, {id: 's16', name: 'KRKY'},
                {id: 's17', name: 'KFC FILLET'}, {id: 's18', name: 'KFC DRUMSTIK'}, {id: 's19', name: 'KFC DARKFILET'}, {id: 's20', name: 'KFC 9ŘEZ'}
            ].map(s => ({ ...s, paletteWeight: 500, stock: 0, isMix: false }));

            appState.zakaznici = [
                {id: 'c1', name: 'Ahold'}, {id: 'c2', name: 'Billa'}, {id: 'c3', name: 'Tesco'},
                {id: 'c4', name: 'Kaufland'}, {id: 'c5', name: 'Lidl'}, {id: 'c6', name: 'Rohlik'},
                {id: 'c7', name: 'KFC'}
            ];

            appState.boxWeights = {};
            appState.zakaznici.forEach(c => {
                appState.boxWeights[c.id] = {};
                appState.suroviny.forEach(s => {
                    appState.boxWeights[c.id][s.id] = 10000;
                });
            });

            appState.orders = [];
            appState.mixDefinitions = {};
            appState.plannedActions = [];
            appState.products = [];
            appState.changes = [];
            appState.wheelchairUsers = [];
            appState.wheelchairSchedule = {}; // { 'YYYY-WW': { 'YYYY-MM-DD': { morning: [id], afternoon: [id], night: [id], vacation: [id] } } }
        }
        
        // --- EVENT BINDING & HANDLING ---
        function bindEvents() {
            DOMElements.navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    appState.ui.activeView = e.currentTarget.dataset.view;
                    render();
                });
            });
            DOMElements.selectedDateInput.addEventListener('change', () => {
                appState.ui.selectedDate = DOMElements.selectedDateInput.value;
                render();
            });
            DOMElements.saveAllBoxWeightsBtn.addEventListener('click', saveAllBoxWeights);
            DOMElements.addNewProductComponentBtn.addEventListener('click', () => renderNewProductComponents(true));
            DOMElements.saveNewProductBtn.addEventListener('click', saveNewProduct);
            DOMElements.cancelEditMixBtn.addEventListener('click', cancelEditMix);
            DOMElements.saveAllPaletteWeightsBtn.addEventListener('click', saveAllPaletteWeights);
            DOMElements.saveMixRatioBtn.addEventListener('click', saveMixRatio);
            DOMElements.saveAddedItemsBtn.addEventListener('click', saveAddedItems);
            DOMElements.saveNewProdBtn.addEventListener('click', saveNewProd);
            DOMElements.cancelEditProdBtn.addEventListener('click', cancelEditProd);
            DOMElements.prevMonthBtn.addEventListener('click', () => changeMonth(-1));
            DOMElements.nextMonthBtn.addEventListener('click', () => changeMonth(1));
            DOMElements.planActionBtn.addEventListener('click', () => openPlanActionModal());
            DOMElements.savePlannedActionBtn.addEventListener('click', savePlannedAction);
            DOMElements.planActionFrom.addEventListener('change', renderDailyCountsForPlanning);
            DOMElements.planActionTo.addEventListener('change', renderDailyCountsForPlanning);
            DOMElements.saveChangeBtn.addEventListener('click', saveChange);
            DOMElements.wcPrevWeekBtn.addEventListener('click', () => wcChangeWeek(-1));
            DOMElements.wcNextWeekBtn.addEventListener('click', () => wcChangeWeek(1));
            DOMElements.wcSaveUserBtn.addEventListener('click', wcSaveUser);
            document.body.addEventListener('click', handleGlobalClick);
        }

        function handleGlobalClick(e) {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const { action, id } = actionTarget.dataset;

            switch (action) {
                case 'add-order-items': openAddOrderModal(id); break;
                case 'delete-order-item': deleteOrderItem(actionTarget.dataset.orderId, actionTarget.dataset.itemId); break;
                case 'edit-mix-ratio': openMixRatioModal(actionTarget.dataset.orderId, actionTarget.dataset.itemId); break;
                case 'delete-new-product-component': actionTarget.closest('.form-row').remove(); updateNewProductTotalPercentage(); break;
                case 'edit-mix': openMixEditor(id); break;
                case 'delete-mix': deleteMix(id); break;
                case 'edit-product': openProductEditor(id); break;
                case 'delete-product': deleteProduct(id); break;
                case 'open-day-details': openDayDetailsModal(actionTarget.dataset.date); break;
                case 'edit-action': openPlanActionModal(id); break;
                case 'delete-action': deletePlannedAction(id); break;
                case 'add-change': openAddChangeModal(); break;
                case 'edit-change': openAddChangeModal(id); break;
                case 'delete-change': deleteChange(id); break;
                case 'open-wheelchair-calendar': appState.ui.activeView = 'wheelchair-calendar'; render(); break;
                case 'wc-add-user': wcOpenUserModal(); break;
                case 'wc-edit-user': wcOpenUserModal(id); break;
                case 'wc-delete-user': wcDeleteUser(id); break;
                case 'wc-show-user-list': wcOpenUserListModal(); break;
                case 'close-modal': actionTarget.closest('.modal').classList.remove('active'); break;
                case 'pc-add-person': initPeopleCalendar(); pcOpenPersonModal(); break;
                case 'pc-edit-person': initPeopleCalendar(); pcOpenPersonModal(id); break;
                case 'pc-delete-person': initPeopleCalendar(); pcDeletePerson(id); break;
            }
        }

        // --- CORE LOGIC ---
        function getDailyNeeds(date, customerFilter = null) {
            const needs = {};
            appState.suroviny.filter(s => !s.isMix).forEach(s => { needs[s.id] = 0; });
            
            let dailyOrders = appState.orders.filter(o => o.date === date);
            let activeActions = appState.plannedActions.filter(a => date >= a.startDate && (!a.endDate || date <= a.endDate));

            if (customerFilter) {
                const kfcCustomer = appState.zakaznici.find(c => c.name.toLowerCase() === 'kfc');
                if (kfcCustomer) {
                    const kfcId = kfcCustomer.id;
                    if (customerFilter === 'kfc') {
                        dailyOrders = dailyOrders.filter(o => o.customerId === kfcId);
                        activeActions = activeActions.filter(a => a.customerId === kfcId);
                    } else if (customerFilter === 'non-kfc') {
                        dailyOrders = dailyOrders.filter(o => o.customerId !== kfcId);
                        activeActions = activeActions.filter(a => a.customerId !== kfcId);
                    }
                }
            }

            const allItemsForDay = [];
            dailyOrders.forEach(order => {
                order.items.forEach(item => allItemsForDay.push({ ...item, customerId: order.customerId }));
            });
            activeActions.forEach(action => {
                const boxCount = action.dailyCounts[date];
                if(boxCount > 0) {
                    allItemsForDay.push({ surovinaId: action.surovinaId, boxCount, customerId: action.customerId });
                }
            });

            allItemsForDay.forEach(item => {
                const surovina = appState.suroviny.find(s => s.id === item.surovinaId);
                if (!surovina) return;
                
                const boxWeightInGrams = appState.boxWeights[item.customerId]?.[surovina.id] || 0;
                const totalWeightInKg = item.boxCount * (boxWeightInGrams / 1000);

                if (surovina.isMix) {
                    const components = item.ratioOverride || appState.mixDefinitions[surovina.id]?.components;
                    if (components) {
                        components.forEach(comp => {
                            const grossWeight = totalWeightInKg * (comp.percentage / 100);
                            const netWeight = grossWeight * (1 - ((comp.loss || 0) / 100));
                            needs[comp.surovinaId] = (needs[comp.surovinaId] || 0) + netWeight;
                        });
                    }
                } else {
                    needs[surovina.id] = (needs[surovina.id] || 0) + totalWeightInKg;
                }
            });
            return needs;
        }

        // --- RENDER FUNCTIONS ---
        function render() {
            DOMElements.navLinks.forEach(l => l.classList.remove('active'));
            DOMElements.views.forEach(v => v.classList.remove('active'));
            
            const activeLink = document.querySelector(`.nav-link[data-view="${appState.ui.activeView}"]`);
            if(activeLink) {
                activeLink.classList.add('active');
                const parentDetails = activeLink.closest('details');
                if (parentDetails) parentDetails.open = true;
            }
            
            const activeView = document.getElementById(`view-${appState.ui.activeView}`);
            if (activeView) activeView.classList.add('active');

            DOMElements.selectedDateInput.value = appState.ui.selectedDate;

            switch (appState.ui.activeView) {
                case 'daily-plan': renderDailyPlan(); break;
                case 'orders': renderOrders(); break;
                case 'calendar': renderCalendar(); break;
                case 'zamestnanci': initPeopleCalendar(); break;
                case 'box-weights': renderBoxWeights(); break;
                case 'create-mix': renderCreateMix(); break;
                case 'create-product': renderCreateProduct(); break;
                case 'palette-weights': renderPaletteWeights(); break;
                case 'zmeny': renderChanges(); break;
                case 'kfc': renderKFC(); break;
                case 'wheelchair-calendar': renderWheelchairCalendar(); break;
            }
        }

        function renderDailyPlan() {
            const todayNeeds = getDailyNeeds(appState.ui.selectedDate, 'non-kfc');
            const nextDay = new Date(appState.ui.selectedDate);
            nextDay.setDate(nextDay.getDate() + 1);
            const tomorrowNeeds = getDailyNeeds(nextDay.toISOString().split('T')[0], 'non-kfc');

            const tbody = DOMElements.surovinyOverviewTableBody;
            tbody.innerHTML = '';
            appState.suroviny.filter(s => !s.isMix).forEach(s => {
                const neededKg = todayNeeds[s.id] || 0;
                const neededPalettes = s.paletteWeight > 0 ? (neededKg / s.paletteWeight) : 0;
                const balancePalettes = (s.stock || 0) - neededPalettes;
                
                let balanceHtml = '';
                if (balancePalettes < -0.01) {
                    balanceHtml = `<span class="shortage">- ${Math.ceil(Math.abs(balancePalettes))}</span>`;
                } else {
                    balanceHtml = `<span class="surplus">+ ${Math.floor(balancePalettes)}</span>`;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.name}</td>
                    <td><input type="number" value="${s.stock || 0}" data-surovina-id="${s.id}" class="stock-input" style="width: 80px;"></td>
                    <td>${neededKg.toFixed(2)} kg</td>
                    <td>${balanceHtml}</td>
                    <td>${(tomorrowNeeds[s.id] || 0).toFixed(2)} kg</td>
                `;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.stock-input').forEach(input => {
                input.addEventListener('change', e => {
                    const surovina = appState.suroviny.find(s => s.id === e.target.dataset.surovinaId);
                    if (surovina) surovina.stock = parseFloat(e.target.value) || 0;
                    saveState();
                    renderDailyPlan();
                });
            });
            renderKalibrTable();
        }

        function renderKFC() {
            const todayNeeds = getDailyNeeds(appState.ui.selectedDate, 'kfc');
            const nextDay = new Date(appState.ui.selectedDate);
            nextDay.setDate(nextDay.getDate() + 1);
            const tomorrowNeeds = getDailyNeeds(nextDay.toISOString().split('T')[0], 'kfc');

            const tbody = DOMElements.kfcOverviewTableBody;
            tbody.innerHTML = '';
            appState.suroviny.filter(s => s.name.toLowerCase().includes('kfc') || ['strips', 'křídla'].includes(s.name.toLowerCase())).forEach(s => {
                 const neededKg = todayNeeds[s.id] || 0;
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td>${s.name}</td>
                    <td>${neededKg.toFixed(2)} kg</td>
                    <td>${(tomorrowNeeds[s.id] || 0).toFixed(2)} kg</td>
                 `;
                 tbody.appendChild(tr);
            });
        }
        
        function renderKalibrTable() {
            DOMElements.kalibrTableContainer.innerHTML = '<p>Zde bude tabulka kalibrace.</p>';
        }

        function renderOrders() {
            const accordion = DOMElements.ordersAccordion;
            accordion.innerHTML = '';
            appState.zakaznici.forEach(customer => {
                const details = document.createElement('details');
                details.dataset.customerId = customer.id;
                if(appState.ui.openAccordionId === customer.id) {
                    details.open = true;
                }
                details.innerHTML = `<summary>${customer.name}</summary><div class="details-content"></div>`;
                const content = details.querySelector('.details-content');
                
                const customerOrders = appState.orders.filter(o => o.customerId === customer.id && o.date === appState.ui.selectedDate);
                const table = document.createElement('table');
                table.className = 'data-table';
                table.innerHTML = `<thead><tr><th>Produkt</th><th>Počet beden</th><th>Akce</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');

                customerOrders.forEach(order => {
                    order.items.forEach(item => {
                        const surovina = appState.suroviny.find(s => s.id === item.surovinaId);
                        if (!surovina) return;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${surovina.name}</td>
                            <td><input type="number" value="${item.boxCount}" data-order-id="${order.id}" data-item-id="${item.id}" class="order-box-count-input" style="width: 80px;"></td>
                            <td class="actions">
                                ${surovina.isMix ? `<button class="btn btn-primary" data-action="edit-mix-ratio" data-order-id="${order.id}" data-item-id="${item.id}">Poměr</button>` : ''}
                                <button class="btn-icon danger" data-action="delete-order-item" data-order-id="${order.id}" data-item-id="${item.id}">${ICONS.trash}</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
                
                content.appendChild(table);
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-success';
                addBtn.textContent = '+ Přidat položky';
                addBtn.dataset.action = 'add-order-items';
                addBtn.dataset.id = customer.id;
                addBtn.style.marginTop = '15px';
                content.appendChild(addBtn);
                accordion.appendChild(details);
            });
            
            accordion.querySelectorAll('.order-box-count-input').forEach(input => {
                input.addEventListener('change', e => {
                    const order = appState.orders.find(o => o.id === e.target.dataset.orderId);
                    const item = order?.items.find(i => i.id === e.target.dataset.itemId);
                    if (item) item.boxCount = parseInt(e.target.value) || 0;
                    saveState();
                });
            });
            accordion.querySelectorAll('details').forEach(detail => {
                detail.addEventListener('toggle', () => {
                    if(detail.open) {
                        appState.ui.openAccordionId = detail.dataset.customerId;
                    } else if (appState.ui.openAccordionId === detail.dataset.customerId) {
                        appState.ui.openAccordionId = null;
                    }
                });
            });
        }
        
        function renderBoxWeights() {
            const accordion = DOMElements.boxWeightsAccordion;
            accordion.innerHTML = '';
            appState.zakaznici.forEach(customer => {
                const details = document.createElement('details');
                details.innerHTML = `<summary>${customer.name}</summary><div class="details-content"></div>`;
                const content = details.querySelector('.details-content');
                const table = document.createElement('table');
                table.className = 'data-table';
                table.innerHTML = `<thead><tr><th>Produkt</th><th>Váha bedny (kg)</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');

                appState.suroviny.forEach(surovina => {
                    const weightInGrams = appState.boxWeights[customer.id]?.[surovina.id] || 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${surovina.name}</td>
                        <td><input type="number" step="0.01" value="${(weightInGrams / 1000).toFixed(2)}" data-customer-id="${customer.id}" data-surovina-id="${surovina.id}" class="box-weight-input" style="width: 100px;"></td>
                    `;
                    tbody.appendChild(tr);
                });
                content.appendChild(table);
                accordion.appendChild(details);
            });
        }

        function renderCreateMix() {
            cancelEditMix();
            renderExistingMixes();
        }
        
        function renderCreateProduct() {
            const { newProdCustomer, newProdSurovina, newProdCalibratedSurovina } = DOMElements;
            
            const customerOptions = appState.zakaznici.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            newProdCustomer.innerHTML = customerOptions;
            
            const surovinaOptions = appState.suroviny.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            newProdSurovina.innerHTML = surovinaOptions;
            newProdCalibratedSurovina.innerHTML = surovinaOptions;
            
            renderExistingProducts();
        }

        function renderExistingProducts() {
            const tbody = DOMElements.existingProductsTableBody;
            tbody.innerHTML = '';
            appState.products.forEach(product => {
                const customer = appState.zakaznici.find(c => c.id === product.customerId);
                const surovina = appState.suroviny.find(s => s.id === product.surovinaId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${product.name}</td>
                    <td>${customer?.name || 'N/A'}</td>
                    <td>${surovina?.name || 'N/A'}</td>
                    <td>${product.boxWeight}</td>
                    <td class="actions">
                        <button class="btn-icon" data-action="edit-product" data-id="${product.id}">${ICONS.edit}</button>
                        <button class="btn-icon danger" data-action="delete-product" data-id="${product.id}">${ICONS.trash}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderChanges() {
            const tbody = DOMElements.changesTableBody;
            tbody.innerHTML = '';
            appState.changes.forEach(change => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(change.dateFrom).toLocaleDateString('cs-CZ')}</td>
                    <td>${change.dateTo ? new Date(change.dateTo).toLocaleDateString('cs-CZ') : '-'}</td>
                    <td>${change.title}</td>
                    <td>${change.text}</td>
                    <td class="actions">
                        <button class="btn-icon" data-action="edit-change" data-id="${change.id}">${ICONS.edit}</button>
                        <button class="btn-icon danger" data-action="delete-change" data-id="${change.id}">${ICONS.trash}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPaletteWeights() {
            const tbody = DOMElements.paletteWeightsTableBody;
            tbody.innerHTML = '';
            appState.suroviny.filter(s => !s.isMix).forEach(surovina => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${surovina.name}</td>
                    <td><input type="number" value="${surovina.paletteWeight || 500}" data-surovina-id="${surovina.id}" class="palette-weight-input" style="width: 120px;"></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderNewProductComponents(addComponent = false, components = []) {
            const container = DOMElements.newProductComponents;
            if (!addComponent) {
                container.innerHTML = '';
            }
            
            const renderRow = (component = {}) => {
                const row = document.createElement('div');
                row.className = 'form-row';
                const rawMaterials = appState.suroviny.filter(s => !s.isMix);
                row.innerHTML = `
                    <div class="form-field" style="flex: 2;">
                        <label>Surovina</label>
                        <select class="new-product-component-surovina">${rawMaterials.map(s => `<option value="${s.id}" ${component.surovinaId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}</select>
                    </div>
                    <div class="form-field">
                        <label>Podíl (%)</label>
                        <input type="number" class="new-product-component-percentage" value="${component.percentage || 0}" min="0" max="100" step="0.1">
                    </div>
                    <div class="form-field">
                        <label>Ztráta (%)</label>
                        <input type="number" class="new-product-component-loss" value="${component.loss || 0}" min="0" max="100" step="0.1">
                    </div>
                    <button class="btn-icon danger" data-action="delete-new-product-component">${ICONS.trash}</button>
                `;
                container.appendChild(row);
            };

            if (addComponent) {
                renderRow();
            } else {
                if (components.length > 0) {
                    components.forEach(renderRow);
                } else {
                    renderRow();
                }
            }
            
            container.querySelectorAll('.new-product-component-percentage, .new-product-component-loss').forEach(input => {
                input.addEventListener('input', updateNewProductTotalPercentage);
            });
            updateNewProductTotalPercentage();
        }

        function updateNewProductTotalPercentage() {
            let total = 0;
            document.querySelectorAll('.new-product-component-percentage').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            const totalEl = DOMElements.newProductTotalPercentage;
            totalEl.textContent = total.toFixed(1);
            totalEl.style.color = Math.abs(total - 100) > 0.1 ? 'var(--accent-danger)' : 'var(--accent-success)';
        }

        function renderExistingMixes() {
            const tbody = DOMElements.existingMixesTableBody;
            if (!tbody) return; 
            tbody.innerHTML = '';
            const mixes = appState.suroviny.filter(s => s.isMix);
            mixes.forEach(mix => {
                const mixDef = appState.mixDefinitions[mix.id];
                if (!mixDef) return;
                const componentsString = mixDef.components.map(c => {
                    const surovina = appState.suroviny.find(s => s.id === c.surovinaId);
                    return `${surovina?.name || '?'} (${c.percentage}%)`;
                }).join(', ');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${mix.name}</td>
                    <td>${componentsString}</td>
                    <td class="actions">
                        <button class="btn-icon" data-action="edit-mix" data-id="${mix.id}">${ICONS.edit}</button>
                        <button class="btn-icon danger" data-action="delete-mix" data-id="${mix.id}">${ICONS.trash}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function changeMonth(delta) {
            appState.ui.calendar.month += delta;
            if (appState.ui.calendar.month > 11) {
                appState.ui.calendar.month = 0;
                appState.ui.calendar.year++;
            } else if (appState.ui.calendar.month < 0) {
                appState.ui.calendar.month = 11;
                appState.ui.calendar.year--;
            }
            renderCalendar();
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        function renderCalendar() {
            const { year, month } = appState.ui.calendar;
            DOMElements.currentMonthDisplay.textContent = new Date(year, month).toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' });
            const grid = DOMElements.calendarGrid;
            grid.innerHTML = '';

            grid.innerHTML += `<div class="calendar-header"></div>`;
            ['Po', 'Út', 'St', 'Čt', 'Pá', 'So', 'Ne'].forEach(day => {
                grid.innerHTML += `<div class="calendar-header">${day}</div>`;
            });

            const firstDayOfMonth = new Date(year, month, 1);
            let dayOfWeek = firstDayOfMonth.getDay();
            if (dayOfWeek === 0) dayOfWeek = 7;
            const offset = dayOfWeek - 1;

            let currentDate = new Date(firstDayOfMonth);
            currentDate.setDate(currentDate.getDate() - offset);

            for (let i = 0; i < 6; i++) {
                const weekNum = getWeekNumber(currentDate);
                grid.innerHTML += `<div class="week-number">${weekNum}</div>`;
                for (let j = 0; j < 7; j++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day';
                    if (currentDate.getMonth() !== month) {
                        dayCell.style.opacity = '0.5';
                    }
                    const dateStr = currentDate.toISOString().split('T')[0];
                    dayCell.dataset.action = 'open-day-details';
                    dayCell.dataset.date = dateStr;

                    dayCell.innerHTML = `<div class="day-number">${currentDate.getDate()}</div><div class="day-items"></div>`;
                    
                    const itemsDiv = dayCell.querySelector('.day-items');
                    const dayActions = appState.plannedActions.filter(a => dateStr >= a.startDate && (!a.endDate || dateStr <= a.endDate));
                    const dayOrders = appState.orders.filter(o => o.date === dateStr);
                    
                    dayActions.forEach(action => {
                        const customer = appState.zakaznici.find(c => c.id === action.customerId);
                        itemsDiv.innerHTML += `<div class="day-pill">${customer?.name || '?'} (Akce)</div>`;
                    });
                    if (dayOrders.length > 0) {
                         itemsDiv.innerHTML += `<div class="day-pill is-order">Objednávka</div>`;
                    }

                    grid.appendChild(dayCell);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
        }
        
        // --- MODAL & EDITOR OPENERS ---
        function openMixEditor(mixId) {
            const mix = appState.suroviny.find(s => s.id === mixId);
            const mixDef = appState.mixDefinitions[mixId];
            if (!mix || !mixDef) return;

            appState.ui.editingMixId = mixId;
            DOMElements.createMixHeader.textContent = `Upravit mix: ${mix.name}`;
            DOMElements.newProductName.value = mix.name;
            DOMElements.saveNewProductBtn.textContent = 'Uložit změny';
            DOMElements.cancelEditMixBtn.style.display = 'inline-block';
            
            renderNewProductComponents(false, mixDef.components);
            window.scrollTo(0, 0);
        }
        
        function openProductEditor(productId) {
            const product = appState.products.find(p => p.id === productId);
            if (!product) return;

            appState.ui.editingProductId = productId;
            DOMElements.createProductHeader.textContent = `Upravit produkt: ${product.name}`;
            DOMElements.newProdName.value = product.name;
            DOMElements.newProdCustomer.value = product.customerId;
            DOMElements.newProdSurovina.value = product.surovinaId;
            DOMElements.newProdBoxWeight.value = product.boxWeight;
            DOMElements.newProdMarinadeName.value = product.marinadeName;
            DOMElements.newProdMarinadePercent.value = product.marinadePercent;
            DOMElements.newProdLossPercent.value = product.lossPercent;
            DOMElements.newProdCalibratedSurovina.value = product.calibratedSurovinaId;
            DOMElements.newProdCalibratedWeight.value = product.calibratedWeight;

            DOMElements.saveNewProdBtn.textContent = 'Uložit změny';
            DOMElements.cancelEditProdBtn.style.display = 'inline-block';
            window.scrollTo(0, 0);
        }

        function openMixRatioModal(orderId, itemId) {
            appState.ui.editingOrderItemId = itemId;
            const order = appState.orders.find(o => o.id === orderId);
            const item = order?.items.find(i => i.id === itemId);
            const surovina = appState.suroviny.find(s => s.id === item.surovinaId);
            if (!item || !surovina || !surovina.isMix) return;

            DOMElements.mixRatioModalTitle.textContent = `Poměr pro: ${surovina.name}`;
            const body = DOMElements.mixRatioModalBody;
            body.innerHTML = '';
            
            const components = item.ratioOverride || appState.mixDefinitions[surovina.id].components;
            components.forEach(comp => {
                const compSurovina = appState.suroviny.find(s => s.id === comp.surovinaId);
                const row = document.createElement('div');
                row.className = 'form-row';
                row.innerHTML = `
                    <div class="form-field" style="flex: 3;"><label>${compSurovina.name}</label></div>
                    <div class="form-field"><input type="number" class="mix-ratio-percentage" value="${comp.percentage}" data-surovina-id="${comp.surovinaId}" min="0" max="100"></div>
                `;
                body.appendChild(row);
            });
            DOMElements.mixRatioModal.classList.add('active');
        }

        function openAddOrderModal(customerId) {
            appState.ui.addingToCustomerId = customerId;
            const customer = appState.zakaznici.find(c => c.id === customerId);
            DOMElements.addOrderModalTitle.textContent = `Přidat objednávku pro: ${customer.name}`;
            const body = DOMElements.addOrderModalBody;
            body.innerHTML = '';
            
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `<thead><tr><th>Produkt</th><th>Počet beden</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            
            appState.suroviny.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.name}</td>
                    <td><input type="number" min="0" class="add-order-box-count" data-surovina-id="${s.id}" style="width: 100px;"></td>
                `;
                tbody.appendChild(tr);
            });
            body.appendChild(table);

            const inputs = body.querySelectorAll('.add-order-box-count');
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (input.value === '') {
                            input.value = 0;
                        }
                        const nextInput = inputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                            nextInput.select();
                        } else {
                            DOMElements.saveAddedItemsBtn.focus();
                        }
                    }
                });
            });

            DOMElements.addOrderModal.classList.add('active');
            if(inputs[0]) {
                inputs[0].focus();
                inputs[0].select();
            }
        }
        
        function openPlanActionModal(actionId = null) {
            appState.ui.editingActionId = actionId;
            const { planActionCustomer, planActionProduct, planActionFrom, planActionTo, planActionModalTitle } = DOMElements;
            
            planActionCustomer.innerHTML = appState.zakaznici.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            planActionProduct.innerHTML = appState.suroviny.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            if (actionId) {
                const action = appState.plannedActions.find(a => a.id === actionId);
                if (action) {
                    planActionModalTitle.textContent = 'Upravit akci';
                    planActionCustomer.value = action.customerId;
                    planActionProduct.value = action.surovinaId;
                    planActionFrom.value = action.startDate;
                    planActionTo.value = action.endDate;
                } else {
                    appState.ui.editingActionId = null;
                    actionId = null;
                }
            } 
            
            if (!actionId) {
                planActionModalTitle.textContent = 'Naplánovat akci';
                planActionFrom.value = '';
                planActionTo.value = '';
            }

            renderDailyCountsForPlanning();
            DOMElements.planActionModal.classList.add('active');
        }

        function renderDailyCountsForPlanning() {
            const { planActionFrom, planActionTo, planActionDailyCounts } = DOMElements;
            const from = planActionFrom.value;
            const to = planActionTo.value;
            planActionDailyCounts.innerHTML = '';
            if (!from || (!to && Object.keys(dailyCounts || {}).length === 0)) return;

            const action = appState.ui.editingActionId ? appState.plannedActions.find(a => a.id === appState.ui.editingActionId) : null;

            let currentDate = new Date(from);
            const endDate = to ? new Date(to) : new Date(from);

            while(currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const count = action?.dailyCounts[dateStr] || 0;
                const dayLabel = currentDate.toLocaleDateString('cs-CZ', { weekday: 'short', day: 'numeric', month: 'numeric' });
                planActionDailyCounts.innerHTML += `
                    <div class="form-row">
                        <label style="flex-basis: 150px;">${dayLabel}</label>
                        <div class="form-field"><input type="number" class="plan-day-count" data-date="${dateStr}" value="${count}" min="0"></div>
                    </div>
                `;
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }
        
        function openDayDetailsModal(date) {
            DOMElements.dayDetailsTitle.textContent = new Date(date + 'T00:00:00').toLocaleDateString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'long' });
            const body = DOMElements.dayDetailsBody;
            body.innerHTML = '';
            
            const dayActions = appState.plannedActions.filter(a => date >= a.startDate && (!a.endDate || date <= a.endDate));
            const dayOrders = appState.orders.filter(o => o.date === date);

            if (dayActions.length === 0 && dayOrders.length === 0) {
                body.innerHTML = '<p>Žádné události pro tento den.</p>';
            } else {
                if (dayActions.length > 0) {
                    body.innerHTML += '<h3>Naplánované akce</h3>';
                    dayActions.forEach(action => {
                        const customer = appState.zakaznici.find(c => c.id === action.customerId);
                        const product = appState.suroviny.find(s => s.id === action.surovinaId);
                        body.innerHTML += `
                            <div class="card" style="padding: 10px; margin-bottom: 10px;">
                                <strong>${product?.name || '?'}</strong> pro ${customer?.name || '?'} (${action.dailyCounts[date]} beden)
                                <div class="actions" style="float: right;">
                                    <button class="btn-icon" data-action="edit-action" data-id="${action.id}">${ICONS.edit}</button>
                                    <button class="btn-icon danger" data-action="delete-action" data-id="${action.id}">${ICONS.trash}</button>
                                </div>
                            </div>
                        `;
                    });
                }
                 if (dayOrders.length > 0) {
                    body.innerHTML += '<h3>Standardní objednávky</h3><p>Upravujte v záložce Objednávky.</p>';
                 }
            }
            DOMElements.dayDetailsModal.classList.add('active');
        }
        
        function openAddChangeModal(changeId = null) {
            const { addChangeModal, addChangeModalTitle, changeDateFrom, changeDateTo, changeTitle, changeText } = DOMElements;
            appState.ui.editingChangeId = changeId;

            if (changeId) {
                const change = appState.changes.find(c => c.id === changeId);
                if (change) {
                    addChangeModalTitle.textContent = "Upravit změnu";
                    changeDateFrom.value = change.dateFrom;
                    changeDateTo.value = change.dateTo || '';
                    changeTitle.value = change.title;
                    changeText.value = change.text;
                }
            } else {
                addChangeModalTitle.textContent = "Přidat změnu";
                changeDateFrom.value = new Date().toISOString().split('T')[0];
                changeDateTo.value = '';
                changeTitle.value = '';
                changeText.value = '';
            }
            addChangeModal.classList.add('active');
        }

        // --- SAVE, UPDATE, DELETE FUNCTIONS ---
        function cancelEditMix() {
            appState.ui.editingMixId = null;
            DOMElements.createMixHeader.textContent = 'Vytvořit nový mix';
            DOMElements.newProductName.value = '';
            DOMElements.saveNewProductBtn.textContent = 'Uložit mix';
            DOMElements.cancelEditMixBtn.style.display = 'none';
            renderNewProductComponents();
        }
        
        function cancelEditProd() {
            appState.ui.editingProductId = null;
            DOMElements.createProductHeader.textContent = 'Vytvořit nový produkt';
            DOMElements.newProdName.value = '';
            DOMElements.newProdBoxWeight.value = '';
            DOMElements.newProdMarinadeName.value = '';
            DOMElements.newProdMarinadePercent.value = '';
            DOMElements.newProdLossPercent.value = '';
            DOMElements.newProdCalibratedWeight.value = '';
            DOMElements.saveNewProdBtn.textContent = 'Uložit produkt';
            DOMElements.cancelEditProdBtn.style.display = 'none';
        }

        function saveAddedItems() {
            const customerId = appState.ui.addingToCustomerId;
            if (!customerId) return;

            let order = appState.orders.find(o => o.customerId === customerId && o.date === appState.ui.selectedDate);
            if (!order) {
                order = { id: generateId(), date: appState.ui.selectedDate, customerId, items: [] };
                appState.orders.push(order);
            }
            
            document.querySelectorAll('.add-order-box-count').forEach(input => {
                const boxCount = parseInt(input.value);
                if (boxCount > 0) {
                    const surovinaId = input.dataset.surovinaId;
                    order.items.push({ id: generateId(), surovinaId, boxCount });
                }
            });
            
            appState.ui.openAccordionId = customerId;
            saveState();
            renderOrders();
            DOMElements.addOrderModal.classList.remove('active');
            showToast('Položky přidány do objednávky');
        }

        function deleteOrderItem(orderId, itemId) {
            const order = appState.orders.find(o => o.id === orderId);
            if (order) {
                appState.ui.openAccordionId = order.customerId;
                order.items = order.items.filter(i => i.id !== itemId);
                if (order.items.length === 0) {
                    appState.orders = appState.orders.filter(o => o.id !== orderId);
                }
            }
            saveState();
            renderOrders();
        }

        function saveAllBoxWeights() {
            document.querySelectorAll('.box-weight-input').forEach(input => {
                const { customerId, surovinaId } = input.dataset;
                if (!appState.boxWeights[customerId]) appState.boxWeights[customerId] = {};
                const weightInKg = parseFloat(input.value) || 0;
                appState.boxWeights[customerId][surovinaId] = Math.round(weightInKg * 1000);
            });
            saveState();
            showToast('Váhy beden uloženy');
        }

        function saveAllPaletteWeights() {
            document.querySelectorAll('.palette-weight-input').forEach(input => {
                const surovina = appState.suroviny.find(s => s.id === input.dataset.surovinaId);
                if (surovina) surovina.paletteWeight = parseFloat(input.value) || 0;
            });
            saveState();
            showToast('Váhy palet uloženy');
        }
        
        function saveNewProd() {
            const { newProdName, newProdCustomer, newProdSurovina, newProdBoxWeight, newProdMarinadeName, newProdMarinadePercent, newProdLossPercent, newProdCalibratedSurovina, newProdCalibratedWeight } = DOMElements;

            const name = newProdName.value.trim();
            if (!name) {
                showToast('Zadejte název produktu.', 'error');
                return;
            }
            
            const productData = {
                name: name,
                customerId: newProdCustomer.value,
                surovinaId: newProdSurovina.value,
                boxWeight: parseFloat(newProdBoxWeight.value) || 0,
                marinadeName: newProdMarinadeName.value.trim(),
                marinadePercent: parseFloat(newProdMarinadePercent.value) || 0,
                lossPercent: parseFloat(newProdLossPercent.value) || 0,
                calibratedSurovinaId: newProdCalibratedSurovina.value,
                calibratedWeight: newProdCalibratedWeight.value.trim()
            };

            if (appState.ui.editingProductId) {
                const index = appState.products.findIndex(p => p.id === appState.ui.editingProductId);
                if (index !== -1) {
                    appState.products[index] = { ...appState.products[index], ...productData };
                    showToast('Produkt upraven');
                }
            } else {
                appState.products.push({ id: generateId(), ...productData });
                showToast('Nový produkt uložen.');
            }
            
            saveState();
            cancelEditProd();
            renderCreateProduct();
        }
        
        function deleteProduct(productId) {
            showConfirmation('Opravdu chcete smazat tento produkt?', () => {
                appState.products = appState.products.filter(p => p.id !== productId);
                saveState();
                renderCreateProduct();
                showToast('Produkt smazán', 'success');
            });
        }

        function saveNewProduct() {
            const name = DOMElements.newProductName.value.trim().toUpperCase();
            if (!name) { showToast('Zadejte název mixu.', 'error'); return; }

            const isEditing = !!appState.ui.editingMixId;
            if (!isEditing && appState.suroviny.some(s => s.name === name)) {
                showToast('Produkt s tímto názvem již existuje.', 'error'); return;
            }

            const components = [];
            let totalPercentage = 0;
            document.querySelectorAll('#new-product-components .form-row').forEach(row => {
                const select = row.querySelector('.new-product-component-surovina');
                const percentageInput = row.querySelector('.new-product-component-percentage');
                const lossInput = row.querySelector('.new-product-component-loss');
                const percentage = parseFloat(percentageInput.value) || 0;
                const loss = parseFloat(lossInput.value) || 0;
                if (percentage > 0) {
                    components.push({ surovinaId: select.value, percentage, loss });
                    totalPercentage += percentage;
                }
            });

            if (components.length === 0) { showToast('Mix musí mít alespoň jednu složku.', 'error'); return; }
            if (Math.abs(totalPercentage - 100) > 0.1) { showToast('Součet podílů musí být 100%.', 'error'); return; }

            if (isEditing) {
                const mixProduct = appState.suroviny.find(s => s.id === appState.ui.editingMixId);
                mixProduct.name = name;
                appState.mixDefinitions[appState.ui.editingMixId].components = components;
                showToast('Mix upraven');
            } else {
                const newMixId = generateId();
                const newMixProduct = { id: newMixId, name, paletteWeight: 0, stock: 0, isMix: true };
                appState.suroviny.push(newMixProduct);
                appState.mixDefinitions[newMixId] = { components };
                
                appState.zakaznici.forEach(c => {
                    if (!appState.boxWeights[c.id]) appState.boxWeights[c.id] = {};
                    appState.boxWeights[c.id][newMixId] = 10000;
                });
                showToast('Nový mix uložen');
            }

            saveState();
            cancelEditMix();
            renderCreateMix();
        }
        
        function deleteMix(mixId) {
            const isUsedInProducts = appState.products.some(p => p.surovinaId === mixId || p.calibratedSurovinaId === mixId);
            if (isUsedInProducts) {
                showToast('Tento mix nelze smazat, je použit v existujícím produktu.', 'error');
                return;
            }
            
            showConfirmation('Opravdu chcete smazat tento mix? Bude odstraněn i ze všech objednávek.', () => {
                appState.suroviny = appState.suroviny.filter(s => s.id !== mixId);
                delete appState.mixDefinitions[mixId];
                appState.orders.forEach(order => {
                    order.items = order.items.filter(item => item.surovinaId !== mixId);
                });
                saveState();
                renderCreateMix();
                showToast('Mix smazán', 'success');
            });
        }
        
        function saveMixRatio() {
            const itemId = appState.ui.editingOrderItemId;
            const order = appState.orders.find(o => o.items.some(i => i.id === itemId));
            const item = order?.items.find(i => i.id === itemId);
            if (!item) return;

            const newRatios = [];
            let total = 0;
            document.querySelectorAll('#mix-ratio-modal-body .mix-ratio-percentage').forEach(input => {
                const percentage = parseFloat(input.value) || 0;
                total += percentage;
                newRatios.push({ surovinaId: input.dataset.surovinaId, percentage });
            });

            if (Math.abs(total - 100) > 0.1) { showToast('Součet musí být 100%', 'error'); return; }

            item.ratioOverride = newRatios;
            saveState();
            DOMElements.mixRatioModal.classList.remove('active');
            showToast('Poměr pro objednávku upraven');
        }

        function savePlannedAction() {
            const { planActionCustomer, planActionProduct, planActionFrom, planActionTo } = DOMElements;
            const dailyCounts = {};
            document.querySelectorAll('.plan-day-count').forEach(input => {
                const count = parseInt(input.value);
                if (count > 0) {
                    dailyCounts[input.dataset.date] = count;
                }
            });

            if (Object.keys(dailyCounts).length === 0 && !planActionTo.value) {
                showToast('Zadejte počet beden alespoň pro jeden den nebo vyplňte datum "Do".', 'error');
                return;
            }

            if (appState.ui.editingActionId) {
                const action = appState.plannedActions.find(a => a.id === appState.ui.editingActionId);
                action.customerId = planActionCustomer.value;
                action.surovinaId = planActionProduct.value;
                action.startDate = planActionFrom.value;
                action.endDate = planActionTo.value;
                action.dailyCounts = dailyCounts;
                showToast('Akce upravena');
            } else {
                appState.plannedActions.push({
                    id: generateId(),
                    customerId: planActionCustomer.value,
                    surovinaId: planActionProduct.value,
                    startDate: planActionFrom.value,
                    endDate: planActionTo.value,
                    dailyCounts
                });
                showToast('Akce naplánována');
            }
            saveState();
            DOMElements.planActionModal.classList.remove('active');
            if(appState.ui.activeView === 'calendar') renderCalendar();
            if(appState.ui.activeView === 'daily-plan') renderDailyPlan();
        }

        function deletePlannedAction(actionId) {
            showConfirmation('Opravdu chcete smazat tuto naplánovanou akci?', () => {
                appState.plannedActions = appState.plannedActions.filter(a => a.id !== actionId);
                saveState();
                DOMElements.dayDetailsModal.classList.remove('active');
                renderCalendar();
                showToast('Akce smazána', 'success');
            });
        }
        
        function saveChange() {
            const { addChangeModal, changeDateFrom, changeDateTo, changeTitle, changeText } = DOMElements;
            const title = changeTitle.value.trim();
            const text = changeText.value.trim();
            const dateFrom = changeDateFrom.value;
            const dateTo = changeDateTo.value;

            if (!title || !dateFrom) {
                showToast('Datum "od" a nadpis jsou povinné.', 'error');
                return;
            }

            if (appState.ui.editingChangeId) {
                const change = appState.changes.find(c => c.id === appState.ui.editingChangeId);
                if (change) {
                    change.dateFrom = dateFrom;
                    change.dateTo = dateTo;
                    change.title = title;
                    change.text = text;
                    showToast('Změna upravena');
                }
            } else {
                appState.changes.push({ id: generateId(), dateFrom, dateTo, title, text });
                showToast('Změna uložena');
            }
            
            saveState();
            renderChanges();
            addChangeModal.classList.remove('active');
        }

        function deleteChange(changeId) {
            showConfirmation('Opravdu chcete smazat tuto změnu?', () => {
                appState.changes = appState.changes.filter(c => c.id !== changeId);
                saveState();
                renderChanges();
                showToast('Změna smazána', 'success');
            });
        }
        
        // --- UTILITY FUNCTIONS ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            DOMElements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function showConfirmation(message, onConfirm) {
            const { confirmationModal, confirmationModalBody, confirmationConfirmBtn, confirmationCancelBtn } = DOMElements;
            
            confirmationModalBody.innerHTML = `<p>${message}</p>`;
            confirmationModal.classList.add('active');

            const confirmHandler = () => {
                onConfirm();
                closeAndCleanup();
            };
            
            const cancelHandler = () => {
                closeAndCleanup();
            };

            function closeAndCleanup() {
                confirmationModal.classList.remove('active');
                confirmationConfirmBtn.removeEventListener('click', confirmHandler);
                confirmationCancelBtn.removeEventListener('click', cancelHandler);
            }
            
            confirmationConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            confirmationCancelBtn.addEventListener('click', cancelHandler, { once: true });
        }

        // --- PEOPLE CALENDAR SCRIPT ---
        let peopleCalendarInitialized = false;
        let pcState = {};
        let pcDOMElements = {};
        const workPositions = ['bizzerba', 'řízky pas', 'dočistování', 'robot', 'icut', 'maykawa', 'manipulant', 'mleté maso', 'lima', 'kfc', 'špízy', 'nezařazené'];

        function initPeopleCalendar() {
            if (peopleCalendarInitialized) return;
            peopleCalendarInitialized = true;

            pcDOMElements = {
                grid: document.getElementById('pc-calendar-grid'),
                monthDisplay: document.getElementById('pc-current-month-display'),
                prevBtn: document.getElementById('pc-prev-month-btn'),
                nextBtn: document.getElementById('pc-next-month-btn'),
                showShiftsBtn: document.getElementById('pc-show-shifts-btn'),
                shiftsModal: document.getElementById('pc-shifts-modal'),
                personModal: document.getElementById('pc-person-modal'),
                personModalTitle: document.getElementById('pc-person-modal-title'),
                savePersonBtn: document.getElementById('pc-save-person-btn'),
                shift1List: document.getElementById('pc-shift1-list'),
                shift2List: document.getElementById('pc-shift2-list'),
                shift1Count: document.getElementById('pc-shift1-count'),
                shift2Count: document.getElementById('pc-shift2-count'),
                personForm: {
                    firstName: document.getElementById('pc-person-firstname'),
                    lastName: document.getElementById('pc-person-lastname'),
                    chip: document.getElementById('pc-person-chip'),
                    phone: document.getElementById('pc-person-phone'),
                    shift: document.getElementById('pc-person-shift'),
                    gender: document.getElementById('pc-person-gender'),
                    position: document.getElementById('pc-person-position'),
                }
            };

            pcState = {
                people: [],
                ui: {
                    year: new Date().getFullYear(),
                    month: new Date().getMonth(),
                    editingPersonId: null,
                }
            };
            
            pcDOMElements.prevBtn.onclick = () => { pcState.ui.month--; if(pcState.ui.month < 0) { pcState.ui.month = 11; pcState.ui.year--; } pcRenderCalendar(); };
            pcDOMElements.nextBtn.onclick = () => { pcState.ui.month++; if(pcState.ui.month > 11) { pcState.ui.month = 0; pcState.ui.year++; } pcRenderCalendar(); };
            pcDOMElements.showShiftsBtn.onclick = pcShowShiftsModal;
            pcDOMElements.savePersonBtn.onclick = pcSavePerson;

            pcLoadState();
            pcRenderCalendar();
        }

        function pcSaveState() {
            localStorage.setItem('peopleCalendarData_v3', JSON.stringify({ people: pcState.people }));
        }

        function pcLoadState() {
            const data = JSON.parse(localStorage.getItem('peopleCalendarData_v3'));
            if (data && data.people) {
                pcState.people = data.people;
            }
        }

        function pcRenderCalendar() {
            const { year, month } = pcState.ui;
            pcDOMElements.monthDisplay.textContent = new Date(year, month).toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' });
            const grid = pcDOMElements.grid;
            grid.innerHTML = '';

            const firstDayOfMonth = new Date(year, month, 1);
            let dayOfWeek = firstDayOfMonth.getDay();
            if (dayOfWeek === 0) dayOfWeek = 7;
            const offset = dayOfWeek - 1;

            let currentDate = new Date(firstDayOfMonth);
            currentDate.setDate(currentDate.getDate() - offset);

            for (let i = 0; i < 6; i++) {
                for (let j = 0; j < 7; j++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day';
                    if (currentDate.getMonth() !== month) {
                        dayCell.style.opacity = '0.5';
                    }
                    dayCell.innerHTML = `<div class="day-number">${currentDate.getDate()}</div>`;
                    grid.appendChild(dayCell);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
        }
        
        function pcShowShiftsModal() {
            const { shift1List, shift2List, shift1Count, shift2Count } = pcDOMElements;
            shift1List.innerHTML = '';
            shift2List.innerHTML = '';
            
            const shift1 = pcState.people.filter(p => p.shift === '1');
            const shift2 = pcState.people.filter(p => p.shift === '2');

            shift1Count.textContent = shift1.length;
            shift2Count.textContent = shift2.length;

            shift1.forEach(p => shift1List.innerHTML += createPersonItemHTML(p));
            shift2.forEach(p => shift2List.innerHTML += createPersonItemHTML(p));
            
            pcDOMElements.shiftsModal.classList.add('active');
        }
        
        function createPersonItemHTML(person) {
            return `
                <div class="pc-person-item">
                    <div class="pc-person-info">
                        <strong>${person.firstName} ${person.lastName}</strong>
                        <small>Čip: ${person.chip} | ${person.position}</small>
                    </div>
                    <div>
                        <button class="btn-icon" data-action="pc-edit-person" data-id="${person.id}">${ICONS.edit}</button>
                        <button class="btn-icon danger" data-action="pc-delete-person" data-id="${person.id}">${ICONS.trash}</button>
                    </div>
                </div>`;
        }
        
        function pcOpenPersonModal(personId = null) {
            pcState.ui.editingPersonId = personId;
            const form = pcDOMElements.personForm;
            
            form.position.innerHTML = workPositions.map(p => `<option value="${p}">${p.charAt(0).toUpperCase() + p.slice(1)}</option>`).join('');

            if (personId) {
                const person = pcState.people.find(p => p.id === personId);
                pcDOMElements.personModalTitle.textContent = 'Upravit osobu';
                form.firstName.value = person.firstName;
                form.lastName.value = person.lastName;
                form.chip.value = person.chip;
                form.phone.value = person.phone;
                form.shift.value = person.shift;
                form.gender.value = person.gender;
                form.position.value = person.position;
            } else {
                pcDOMElements.personModalTitle.textContent = 'Přidat osobu';
                Object.values(form).forEach(input => { if (input.tagName === 'INPUT') input.value = ''; });
                form.shift.value = '1';
                form.gender.value = 'muz';
            }
            pcDOMElements.personModal.classList.add('active');
        }
        
        function pcSavePerson() {
            const form = pcDOMElements.personForm;
            if (!form.firstName.value || !form.lastName.value || !form.chip.value) {
                showToast('Jméno, příjmení a čip jsou povinné.', 'error');
                return;
            }
            
            const personData = {
                id: pcState.ui.editingPersonId || crypto.randomUUID(),
                firstName: form.firstName.value,
                lastName: form.lastName.value,
                chip: form.chip.value,
                phone: form.phone.value,
                shift: form.shift.value,
                gender: form.gender.value,
                position: form.position.value,
            };

            if (pcState.ui.editingPersonId) {
                const index = pcState.people.findIndex(p => p.id === pcState.ui.editingPersonId);
                pcState.people[index] = personData;
            } else {
                pcState.people.push(personData);
            }
            
            pcSaveState();
            pcShowShiftsModal();
            pcDOMElements.personModal.classList.remove('active');
            showToast('Osoba uložena');
        }
        
        function pcDeletePerson(personId) {
            showConfirmation('Opravdu chcete smazat tuto osobu?', () => {
                pcState.people = pcState.people.filter(p => p.id !== personId);
                pcSaveState();
                pcShowShiftsModal();
                showToast('Osoba smazána', 'success');
            });
        }
        
        // --- WHEELCHAIR CALENDAR SCRIPT ---
        function wcChangeWeek(delta) {
            let { year, week } = appState.ui.wheelchairCalendar;
            week += delta;
            if (week > 52) {
                week = 1;
                year++;
            } else if (week < 1) {
                week = 52;
                year--;
            }
            appState.ui.wheelchairCalendar.year = year;
            appState.ui.wheelchairCalendar.week = week;
            renderWheelchairCalendar();
        }

        function getDateOfWeek(w, y) {
            const d = (1 + (w - 1) * 7); // 1st day of the week
            return new Date(y, 0, d);
        }

        function renderWheelchairCalendar() {
            const { year, week } = appState.ui.wheelchairCalendar;
            const weekKey = `${year}-${week.toString().padStart(2, '0')}`;
            
            // Auto-generate schedule if it doesn't exist
            if (!appState.wheelchairSchedule[weekKey]) {
                wcGenerateScheduleForWeek(year, week);
            }
            const schedule = appState.wheelchairSchedule[weekKey] || {};

            const startDate = getDateOfWeek(week, year);
            DOMElements.wcCurrentWeekDisplay.textContent = `Týden ${week} (${startDate.toLocaleDateString('cs-CZ')})`;
            const container = DOMElements.wcCalendarContainer;
            container.innerHTML = '';

            // Headers
            container.innerHTML += `<div class="wc-header-cell"></div>`;
            const days = ['Po', 'Út', 'St', 'Čt', 'Pá', 'So', 'Ne'];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startDate);
                day.setDate(day.getDate() + i);
                container.innerHTML += `<div class="wc-header-cell">${days[i]}<br>${day.toLocaleDateString('cs-CZ', {day: '2-digit', month: '2-digit'})}</div>`;
            }

            // Shifts
            const shifts = ['morning', 'afternoon', 'night', 'vacation'];
            const shiftNames = {'morning': 'Ranní', 'afternoon': 'Odpolední', 'night': 'Noční', 'vacation': 'Dovolená'};
            
            shifts.forEach(shift => {
                container.innerHTML += `<div class="wc-shift-cell">${shiftNames[shift]}</div>`;
                for (let i = 0; i < 7; i++) {
                    const day = new Date(startDate);
                    day.setDate(day.getDate() + i);
                    const dateKey = day.toISOString().split('T')[0];
                    const dayCell = document.createElement('div');
                    dayCell.className = 'wc-day-cell';
                    dayCell.dataset.date = dateKey;
                    dayCell.dataset.shift = shift;
                    
                    const userIds = schedule[dateKey]?.[shift] || [];
                    userIds.forEach(userId => {
                        const user = appState.wheelchairUsers.find(u => u.id === userId);
                        if (user) {
                            const pill = document.createElement('div');
                            pill.className = `wc-user-pill ${shift}`;
                            pill.textContent = `${user.firstName} ${user.lastName}`;
                            pill.dataset.userId = user.id;
                            pill.draggable = true;
                            dayCell.appendChild(pill);
                        }
                    });
                    container.appendChild(dayCell);
                }
            });
            
            // Drag and Drop listeners
            container.querySelectorAll('.wc-user-pill').forEach(pill => {
                pill.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', pill.dataset.userId);
                    setTimeout(() => pill.classList.add('dragging'), 0);
                });
                pill.addEventListener('dragend', () => pill.classList.remove('dragging'));
            });

            container.querySelectorAll('.wc-day-cell').forEach(cell => {
                cell.addEventListener('dragover', e => e.preventDefault());
                cell.addEventListener('drop', e => {
                    e.preventDefault();
                    const userId = e.dataTransfer.getData('text/plain');
                    const targetDate = cell.dataset.date;
                    const targetShift = cell.dataset.shift;
                    
                    // Remove from old position
                    Object.keys(schedule).forEach(date => {
                        Object.keys(schedule[date]).forEach(shift => {
                            schedule[date][shift] = schedule[date][shift].filter(id => id !== userId);
                        });
                    });

                    // Add to new position
                    if (!schedule[targetDate]) schedule[targetDate] = { morning: [], afternoon: [], night: [], vacation: [] };
                    if (!schedule[targetDate][targetShift].includes(userId)) {
                        schedule[targetDate][targetShift].push(userId);
                    }
                    
                    saveState();
                    renderWheelchairCalendar();
                });
            });
        }

        function wcGenerateScheduleForWeek(year, week) {
            const weekKey = `${year}-${week.toString().padStart(2, '0')}`;
            let prevYear = year;
            let prevWeek = week - 1;
            if (prevWeek < 1) {
                prevWeek = 52;
                prevYear--;
            }
            const prevWeekKey = `${prevYear}-${prevWeek.toString().padStart(2, '0')}`;
            const prevSchedule = appState.wheelchairSchedule[prevWeekKey];

            const newSchedule = {};
            const startDate = getDateOfWeek(week, year);

            if (prevSchedule) { // Rotate based on previous week
                for (let i = 0; i < 7; i++) {
                    const day = new Date(startDate);
                    day.setDate(day.getDate() + i);
                    const dateKey = day.toISOString().split('T')[0];
                    
                    const prevDay = new Date(day);
                    prevDay.setDate(prevDay.getDate() - 7);
                    const prevDateKey = prevDay.toISOString().split('T')[0];
                    
                    const prevDaySchedule = prevSchedule[prevDateKey] || { morning: [], afternoon: [], night: [], vacation: [] };
                    
                    newSchedule[dateKey] = {
                        morning: [...prevDaySchedule.night],
                        afternoon: [...prevDaySchedule.morning],
                        night: [...prevDaySchedule.afternoon],
                        vacation: [...prevDaySchedule.vacation]
                    };
                }
            } else { // Default assignment for the first time
                const users = [...appState.wheelchairUsers];
                const shifts = ['morning', 'afternoon', 'night'];
                let shiftIndex = 0;
                
                for (let i = 0; i < 7; i++) {
                    const day = new Date(startDate);
                    day.setDate(day.getDate() + i);
                    const dateKey = day.toISOString().split('T')[0];
                    newSchedule[dateKey] = { morning: [], afternoon: [], night: [], vacation: [] };
                }

                users.forEach(user => {
                    const shift = shifts[shiftIndex % 3];
                    // Assign to all days of the week in the same shift
                    for (let i = 0; i < 7; i++) {
                         const day = new Date(startDate);
                         day.setDate(day.getDate() + i);
                         const dateKey = day.toISOString().split('T')[0];
                         newSchedule[dateKey][shift].push(user.id);
                    }
                    shiftIndex++;
                });
            }
            appState.wheelchairSchedule[weekKey] = newSchedule;
            saveState();
        }

        function wcChangeWeek(delta) {
            let { year, week } = appState.ui.wheelchairCalendar;
            const d = getDateOfWeek(week, year);
            d.setDate(d.getDate() + (delta * 7));
            appState.ui.wheelchairCalendar.year = d.getFullYear();
            appState.ui.wheelchairCalendar.week = getWeekNumber(d);
            renderWheelchairCalendar();
        }
        
        function wcOpenUserModal(userId = null) {
            appState.ui.editingWcUserId = userId;
            const { wcUserModal, wcUserModalTitle, wcUserFirstName, wcUserLastName, wcUserChip, wcUserPhone } = DOMElements;
            if (userId) {
                const user = appState.wheelchairUsers.find(u => u.id === userId);
                if (user) {
                    wcUserModalTitle.textContent = 'Upravit vozíčkáře';
                    wcUserFirstName.value = user.firstName;
                    wcUserLastName.value = user.lastName;
                    wcUserChip.value = user.chip;
                    wcUserPhone.value = user.phone;
                }
            } else {
                wcUserModalTitle.textContent = 'Přidat vozíčkáře';
                wcUserFirstName.value = '';
                wcUserLastName.value = '';
                wcUserChip.value = '';
                wcUserPhone.value = '';
            }
            wcUserModal.classList.add('active');
        }

        function wcSaveUser() {
            const { wcUserFirstName, wcUserLastName, wcUserChip, wcUserPhone } = DOMElements;
            const firstName = wcUserFirstName.value.trim();
            const lastName = wcUserLastName.value.trim();
            const chip = wcUserChip.value.trim();
            if (!firstName || !lastName || !chip) {
                showToast('Jméno, příjmení a čip jsou povinné.', 'error');
                return;
            }
            
            const userData = {
                firstName, lastName, chip, phone: wcUserPhone.value.trim()
            };

            if (appState.ui.editingWcUserId) {
                const index = appState.wheelchairUsers.findIndex(u => u.id === appState.ui.editingWcUserId);
                if (index > -1) {
                    appState.wheelchairUsers[index] = { ...appState.wheelchairUsers[index], ...userData };
                    showToast('Uživatel upraven');
                }
            } else {
                appState.wheelchairUsers.push({ id: generateId(), ...userData });
                showToast('Uživatel přidán');
            }
            saveState();
            DOMElements.wcUserModal.classList.remove('active');
            if (DOMElements.wcUserListModal.classList.contains('active')) {
                wcOpenUserListModal();
            }
            renderWheelchairCalendar(); // Re-render to include new user
        }
        
        function wcDeleteUser(userId) {
            showConfirmation('Opravdu chcete smazat tohoto vozíčkáře ze systému?', () => {
                appState.wheelchairUsers = appState.wheelchairUsers.filter(u => u.id !== userId);
                // Also remove from all schedules
                Object.keys(appState.wheelchairSchedule).forEach(weekKey => {
                    const weekSchedule = appState.wheelchairSchedule[weekKey];
                    Object.keys(weekSchedule).forEach(dateKey => {
                        const daySchedule = weekSchedule[dateKey];
                        daySchedule.morning = daySchedule.morning.filter(id => id !== userId);
                        daySchedule.afternoon = daySchedule.afternoon.filter(id => id !== userId);
                        daySchedule.night = daySchedule.night.filter(id => id !== userId);
                        daySchedule.vacation = daySchedule.vacation.filter(id => id !== userId);
                    });
                });
                saveState();
                wcOpenUserListModal();
                renderWheelchairCalendar();
                showToast('Uživatel smazán');
            });
        }

        function wcOpenUserListModal() {
            const tbody = DOMElements.wcUserListTbody;
            tbody.innerHTML = '';
            appState.wheelchairUsers.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.chip}</td>
                    <td>${user.phone}</td>
                    <td class="actions">
                        <button class="btn-icon" data-action="wc-edit-user" data-id="${user.id}">${ICONS.edit}</button>
                        <button class="btn-icon danger" data-action="wc-delete-user" data-id="${user.id}">${ICONS.trash}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            DOMElements.wcUserListModal.classList.add('active');
        }

        // --- APP INITIALIZATION ---
        loadState();
        bindEvents();
        render();
    });
    </script>
</body>
</html>
